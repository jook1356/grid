# 22. 피벗 부분합/총합계 구현 및 리팩토링 (Pivot Subtotal & Refactoring)

**작성일**: 2026-01-26
**작업자**: Antigravity (Assistant)

## 1. 개요 (Overview)
피벗 테이블의 핵심 기능인 **부분합(Subtotal)**과 **총합계(Grand Total)** 기능을 완성하고, 코드의 안정성과 유지보수성을 높이기 위한 구조적 **리팩토링**을 수행했습니다.
단순한 값 집계를 넘어, 사용자가 보기 편한 계층적 라벨링과 스타일링을 적용하여 완성도 높은 피벗 그리드를 구현했습니다.

## 2. 주요 변경 사항 (Key Changes)

### 2.1. 피벗 프로세서 (PivotProcessor) 강화
- **값 집계 로직 개선**:
  - 기존의 키 생성 방식(`|` 구분자 사용)과 실제 데이터 키(`_` 구분자 사용)의 불일치로 인한 **값 누락 문제**를 해결했습니다.
  - 키 생성 로직을 헬퍼 메서드(`createSubtotalKey`, `createGrandTotalKey`)로 캡슐화하여 일관성을 확보했습니다.
- **헤더 트리 구조 최적화**:
  - 열 소계(Column Subtotal)를 상위 그룹의 '형제'가 아닌 **'자식'** 노드로 배치하여, 상위 헤더가 자연스럽게 병합(colspan)되도록 구조를 변경했습니다.
  - 소계 헤더 라벨을 계층적으로 정돈했습니다 (예: 상위 'Q1', 하위 '소계'로 분리).
- **행 소계(Row Subtotal) 라벨링 개선**:
  - 열 소계와 통일감을 주기 위해, 행 소계 라벨도 그룹 컬럼 바로 다음 컬럼(자식 레벨)에 '소계'를 표시하도록 로직을 변경했습니다.

### 2.2. 렌더링 및 스타일링 (Rendering & Styling)
- **피벗 행 렌더링 방식 변경**:
  - 피벗 소계/총합계 행을 별도의 특수 행이 아닌, **데이터 행(`variant: 'data'`)**으로 처리하여 `BodyRenderer`가 자연스럽게 값을 렌더링하도록 했습니다.
- **CSS 클래스 체계화**:
  - `Row` 컴포넌트와 `default.css`에 소계/총합계 전용 클래스를 추가하여 시각적 구분을 명확히 했습니다.
    - 행: `.ps-row-subtotal`, `.ps-row-grandtotal`
    - 열/셀: `.ps-cell-column-subtotal`, `.ps-cell-column-grandtotal`
  - DOM 재사용 시 스타일이 오염되는 문제를 해결하기 위해 클래스 초기화 로직을 강화했습니다.

### 2.3. 코드 리팩토링 (Refactoring)
- **매직 스트링 제거**: 코드 전반에 산재해 있던 `__subtotal__`, `__grandtotal__`, `'소계'` 등의 문자열을 `pivot.types.ts`의 상수로 추출하여 중앙 관리하도록 개선했습니다.
- **헬퍼 메서드 도입**: 복잡한 문자열 조작 로직을 메서드로 분리하여 가독성을 높였습니다.

## 3. 해결된 문제 (Fixed Issues)
- **소계 값 누락**: 키 생성 구분자 오류(`|` vs `_`) 수정으로 집계 값이 정상 표시됨.
- **헤더 정렬 깨짐**: 소계 컬럼 추가 시 헤더 트리의 깊이(depth)가 맞지 않아 UI가 밀리는 현상을 더미(dummy) 노드 추가로 해결.
- **스타일 적용 오류**: 피벗 모드 전환 시 컬럼 메타데이터가 갱신되지 않아 스타일이 적용되지 않던 문제를 `refresh()` 로직 개선으로 수정.

## 4. 향후 계획 (Future Plan)
- **성능 최적화**: 대용량 데이터에 대한 소계 계산 속도 개선 (현재 재귀적 순회 방식 최적화 필요).
- **소계 위치 옵션**: 소계를 그룹 상단(Top) 또는 하단(Bottom)에 배치할 수 있는 옵션 추가 고려.
