<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ëŒ€ìš©ëŸ‰ í”Œë« ê·¸ë¦¬ë“œ - PureSheet Demo</title>
    <link rel="stylesheet" href="../shared/styles.css">
    <link rel="stylesheet" href="../../src/ui/style/default.css">
    <style>
        .api-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
            min-width: 300px;
        }

        .api-input-group input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--demo-border);
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Fira Code', 'Consolas', monospace;
        }

        .api-input-group input::placeholder {
            color: #aaa;
        }

        .preset-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .preset-buttons button {
            padding: 5px 10px;
            font-size: 12px;
            border: 1px solid var(--demo-border);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .preset-buttons button:hover {
            background: var(--demo-primary);
            color: white;
            border-color: var(--demo-primary);
        }

        .preset-buttons button.active {
            background: var(--demo-primary);
            color: white;
            border-color: var(--demo-primary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .info-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--demo-border);
        }

        .info-item .label {
            font-size: 12px;
            color: var(--demo-text-secondary);
            margin-bottom: 4px;
        }

        .info-item .value {
            font-size: 18px;
            font-weight: 600;
            color: var(--demo-text);
        }

        #grid {
            height: 600px;
        }
    </style>
    <script src="../shared/nav-sidebar.js" defer></script>
</head>

<body>
    <!-- ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav-sidebar></nav-sidebar>

    <!-- í—¤ë” -->
    <div class="demo-header">
        <h1>ğŸŒ API ëŒ€ìš©ëŸ‰ í”Œë« ê·¸ë¦¬ë“œ</h1>
        <span class="badge badge-implemented">êµ¬í˜„ë¨</span>
    </div>

    <!-- ì„¤ëª… -->
    <div class="demo-description">
        <p>
            <strong>PureSheetì˜ <code>api</code> config</strong>ë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€ REST APIì—ì„œ ë°ì´í„°ë¥¼ ì§ì ‘ í˜ì¹­í•©ë‹ˆë‹¤.
            Web Worker ë‚´ë¶€ì—ì„œ fetchê°€ ì‹¤í–‰ë˜ë¯€ë¡œ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ë¸”ë¡œí‚¹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            ì•„ë˜ í”„ë¦¬ì…‹ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ URLì„ ì…ë ¥í•´ ë³´ì„¸ìš”.
        </p>
    </div>

    <div class="demo-container">
        <!-- íˆ´ë°” -->
        <div class="toolbar" style="flex-direction: column; align-items: stretch; gap: 10px;">
            <!-- 1í–‰: í”„ë¦¬ì…‹ -->
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <label style="font-weight: 600; white-space: nowrap;">í”„ë¦¬ì…‹:</label>
                <div class="preset-buttons" id="presets">
                    <button data-preset="photos" class="active">ğŸ“· Photos (5,000ê±´)</button>
                    <button data-preset="comments">ğŸ’¬ Comments (500ê±´)</button>
                    <button data-preset="todos">âœ… Todos (200ê±´)</button>
                    <button data-preset="users">ğŸ‘¤ Users (30ê±´)</button>
                    <button data-preset="products">ğŸ›’ Products (194ê±´)</button>
                </div>
            </div>

            <!-- 2í–‰: URL ì…ë ¥ + fetch ë²„íŠ¼ -->
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <div class="api-input-group">
                    <label style="white-space: nowrap; font-weight: 500;">URL:</label>
                    <input type="text" id="apiUrl" placeholder="https://api.example.com/data" />
                </div>
                <div class="toolbar-group">
                    <label style="white-space: nowrap;">dataProperty:</label>
                    <input type="text" id="dataProp" placeholder="(ë¹„ì›Œë‘ë©´ ì‘ë‹µ ìì²´ê°€ ë°°ì—´)"
                        style="width: 140px; padding: 6px 10px; border: 1px solid var(--demo-border); border-radius: 4px; font-size: 13px;" />
                </div>
                <button onclick="fetchFromApi()" style="padding: 8px 20px; background: var(--demo-primary); color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">
                    ğŸš€ Fetch & Load
                </button>
            </div>
        </div>

        <!-- í•„í„°/ì •ë ¬ íˆ´ë°” -->
        <div class="toolbar" style="border-top: none; background: #f0f4f8;">
            <div class="toolbar-group">
                <label>ğŸ” í•„í„°:</label>
                <select id="filterColumn">
                    <option value="">ì»¬ëŸ¼ ì„ íƒ</option>
                </select>
                <select id="filterOperator">
                    <option value="eq">= ê°™ìŒ</option>
                    <option value="contains">í¬í•¨</option>
                    <option value="neq">â‰  ë‹¤ë¦„</option>
                    <option value="gt">&gt; ì´ˆê³¼</option>
                    <option value="gte">â‰¥ ì´ìƒ</option>
                    <option value="lt">&lt; ë¯¸ë§Œ</option>
                    <option value="lte">â‰¤ ì´í•˜</option>
                    <option value="startsWith">ì‹œì‘</option>
                    <option value="endsWith">ë</option>
                </select>
                <input type="text" id="filterValue" placeholder="ê°’ ì…ë ¥"
                    style="width: 120px; padding: 6px 10px; border: 1px solid var(--demo-border); border-radius: 4px; font-size: 13px;">
                <button onclick="applyFilter()"
                    style="padding: 6px 12px; background: var(--demo-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ì ìš©
                </button>
                <button onclick="clearFilter()"
                    style="padding: 6px 12px; border: 1px solid var(--demo-border); border-radius: 4px; background: white; cursor: pointer;">
                    ì´ˆê¸°í™”
                </button>
            </div>

            <div class="toolbar-divider" style="width:1px;height:24px;background:var(--demo-border);margin:0 8px;"></div>

            <div class="toolbar-group">
                <label>â†•ï¸ ì •ë ¬:</label>
                <select id="sortColumn">
                    <option value="">ì»¬ëŸ¼ ì„ íƒ</option>
                </select>
                <select id="sortDirection">
                    <option value="asc">ì˜¤ë¦„ì°¨ìˆœ â†‘</option>
                    <option value="desc">ë‚´ë¦¼ì°¨ìˆœ â†“</option>
                </select>
                <button onclick="applySort()"
                    style="padding: 6px 12px; background: var(--demo-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ì ìš©
                </button>
                <button onclick="clearSort()"
                    style="padding: 6px 12px; border: 1px solid var(--demo-border); border-radius: 4px; background: white; cursor: pointer;">
                    ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <!-- ê·¸ë¦¬ë“œ -->
        <div id="grid"></div>

        <!-- ìƒíƒœë°” -->
        <div class="status-bar" id="status">í”„ë¦¬ì…‹ì„ ì„ íƒí•˜ê±°ë‚˜ URLì„ ì…ë ¥í•œ í›„ Fetch ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div>
    </div>

    <!-- ì„±ëŠ¥ ì •ë³´ íŒ¨ë„ -->
    <div class="info-panel">
        <h3>ğŸ“ˆ ì„±ëŠ¥ ì¸¡ì •</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="label">API í˜ì¹­ + ì—”ì§„ ë¡œë“œ</div>
                <div class="value" id="fetchTime">-</div>
            </div>
            <div class="info-item">
                <div class="label">ë Œë”ë§</div>
                <div class="value" id="renderTime">-</div>
            </div>
            <div class="info-item">
                <div class="label">ì´ ì†Œìš” ì‹œê°„</div>
                <div class="value" id="totalTime">-</div>
            </div>
            <div class="info-item">
                <div class="label">ë¡œë“œëœ í–‰ ìˆ˜</div>
                <div class="value" id="rowCount">-</div>
            </div>
            <div class="info-item">
                <div class="label">ì»¬ëŸ¼ ìˆ˜</div>
                <div class="value" id="colCount">-</div>
            </div>
            <div class="info-item">
                <div class="label">ëª¨ë“œ</div>
                <div class="value" id="modeInfo">-</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { PureSheet } from '../../src/index.ts';

        let sheet = null;

        // í”„ë¦¬ì…‹ ì •ì˜
        const PRESETS = {
            photos: {
                url: 'https://jsonplaceholder.typicode.com/photos',
                dataProp: '',
                fields: [
                    { key: 'id', header: 'ID', width: 70 },
                    { key: 'albumId', header: 'Album ID', width: 90 },
                    { key: 'title', header: 'Title', width: 400 },
                    { key: 'url', header: 'URL', width: 300 },
                    { key: 'thumbnailUrl', header: 'Thumbnail', width: 300 },
                ],
            },
            comments: {
                url: 'https://jsonplaceholder.typicode.com/comments',
                dataProp: '',
                fields: [
                    { key: 'id', header: 'ID', width: 60 },
                    { key: 'postId', header: 'Post ID', width: 80 },
                    { key: 'name', header: 'Name', width: 250 },
                    { key: 'email', header: 'Email', width: 200 },
                    { key: 'body', header: 'Body', width: 500 },
                ],
            },
            todos: {
                url: 'https://jsonplaceholder.typicode.com/todos',
                dataProp: '',
                fields: [
                    { key: 'id', header: 'ID', width: 60 },
                    { key: 'userId', header: 'User ID', width: 80 },
                    { key: 'title', header: 'Title', width: 500 },
                    { key: 'completed', header: 'Completed', width: 100 },
                ],
            },
            users: {
                url: 'https://dummyjson.com/users?limit=30',
                dataProp: 'users',
                fields: [
                    { key: 'id', header: 'ID', width: 60 },
                    { key: 'firstName', header: 'First Name', width: 120 },
                    { key: 'lastName', header: 'Last Name', width: 120 },
                    { key: 'email', header: 'Email', width: 250 },
                    { key: 'age', header: 'Age', width: 60 },
                    { key: 'gender', header: 'Gender', width: 80 },
                    { key: 'phone', header: 'Phone', width: 150 },
                    { key: 'birthDate', header: 'Birth Date', width: 120 },
                    { key: 'university', header: 'University', width: 250 },
                ],
            },
            products: {
                url: 'https://dummyjson.com/products?limit=194',
                dataProp: 'products',
                fields: [
                    { key: 'id', header: 'ID', width: 60 },
                    { key: 'title', header: 'Title', width: 250 },
                    { key: 'brand', header: 'Brand', width: 120 },
                    { key: 'category', header: 'Category', width: 150 },
                    { key: 'price', header: 'Price', width: 80 },
                    { key: 'discountPercentage', header: 'Discount %', width: 100 },
                    { key: 'rating', header: 'Rating', width: 70 },
                    { key: 'stock', header: 'Stock', width: 70 },
                    { key: 'description', header: 'Description', width: 400 },
                ],
            },
        };

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        function updatePerf(info) {
            for (const [key, val] of Object.entries(info)) {
                const el = document.getElementById(key);
                if (el) el.textContent = val;
            }
        }

        // í”„ë¦¬ì…‹ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        document.getElementById('presets').addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-preset]');
            if (!btn) return;
            const preset = PRESETS[btn.dataset.preset];
            if (!preset) return;

            // active í† ê¸€
            document.querySelectorAll('#presets button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.getElementById('apiUrl').value = preset.url;
            document.getElementById('dataProp').value = preset.dataProp;
        });

        // ì´ˆê¸° í”„ë¦¬ì…‹ ì„¸íŒ…
        const defaultPreset = PRESETS.photos;
        document.getElementById('apiUrl').value = defaultPreset.url;
        document.getElementById('dataProp').value = defaultPreset.dataProp;

        // API í˜ì¹­ & ê·¸ë¦¬ë“œ ìƒì„±
        window.fetchFromApi = async function () {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                updateStatus('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const dataProp = document.getElementById('dataProp').value.trim();
            const totalStart = performance.now();

            updateStatus(`â³ ${url} ì—ì„œ ë°ì´í„° í˜ì¹­ ì¤‘...`);
            updatePerf({
                fetchTime: '...', renderTime: '-', totalTime: '-',
                rowCount: '-', colCount: '-', modeInfo: 'Worker + Arquero',
            });

            // í˜„ì¬ í™œì„± í”„ë¦¬ì…‹ì˜ fields ê°€ì ¸ì˜¤ê¸°
            const activeBtn = document.querySelector('#presets button.active');
            const presetKey = activeBtn?.dataset.preset;
            const presetFields = presetKey ? PRESETS[presetKey].fields : null;

            try {
                // ê¸°ì¡´ ê·¸ë¦¬ë“œ íŒŒê´´
                if (sheet) {
                    sheet.destroy();
                    sheet = null;
                }

                const fetchStart = performance.now();

                // PureSheet api configë¡œ ì§ì ‘ í˜ì¹­
                const apiConfig = {
                    url,
                    method: 'GET',
                    ...(dataProp ? { dataProperty: dataProp } : {}),
                };

                const config = {
                    mode: 'flat',
                    useWorker: true,
                    engine: 'aq',
                    api: apiConfig,
                    theme: 'light',
                    rowHeight: 36,
                    headerHeight: 40,
                };

                // í”„ë¦¬ì…‹ fieldsê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                if (presetFields) {
                    config.fields = presetFields;
                }

                const container = document.getElementById('grid');
                sheet = new PureSheet(container, config);

                // initPromise ëŒ€ê¸° (api fetch + engine load ì™„ë£Œ)
                await sheet.waitForReady();

                const fetchTime = performance.now() - fetchStart;

                const renderStart = performance.now();
                // ë Œë”ë§ì€ waitForReady ë‚´ë¶€ì—ì„œ ì´ë¯¸ ì‹¤í–‰ë¨
                const renderTime = performance.now() - renderStart;

                const totalTime = performance.now() - totalStart;

                const rowCount = sheet.getVisibleRowCount();
                const colCount = sheet.getColumns().length;

                updatePerf({
                    fetchTime: `${Math.round(fetchTime)}ms`,
                    renderTime: `${Math.round(renderTime)}ms`,
                    totalTime: `${Math.round(totalTime)}ms`,
                    rowCount: `${rowCount.toLocaleString()}ê±´`,
                    colCount: `${colCount}ê°œ`,
                    modeInfo: 'Worker + Arquero',
                });

                updateStatus(`âœ… ì™„ë£Œ - ${rowCount.toLocaleString()}ê±´ ë¡œë“œë¨ (${Math.round(totalTime)}ms)`);

                // í•„í„°/ì •ë ¬ ì»¬ëŸ¼ ì…€ë ‰íŠ¸ ë™ì  ì±„ìš°ê¸°
                populateColumnSelects(sheet.getColumns());

            } catch (err) {
                console.error('Fetch error:', err);
                updateStatus(`âŒ ì˜¤ë¥˜: ${err.message}`);
            }
        };

        // í•„í„°/ì •ë ¬ ì…€ë ‰íŠ¸ì— ì»¬ëŸ¼ ëª©ë¡ ì±„ìš°ê¸°
        function populateColumnSelects(columns) {
            const filterSel = document.getElementById('filterColumn');
            const sortSel = document.getElementById('sortColumn');

            // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ "ì»¬ëŸ¼ ì„ íƒ" ìœ ì§€)
            filterSel.innerHTML = '<option value="">ì»¬ëŸ¼ ì„ íƒ</option>';
            sortSel.innerHTML = '<option value="">ì»¬ëŸ¼ ì„ íƒ</option>';

            for (const col of columns) {
                const key = col.key || col;
                const header = col.header || key;
                filterSel.innerHTML += `<option value="${key}">${header}</option>`;
                sortSel.innerHTML += `<option value="${key}">${header}</option>`;
            }
        }

        // í•„í„° ì ìš©
        window.applyFilter = async function () {
            if (!sheet) return;
            const col = document.getElementById('filterColumn').value;
            if (!col) { updateStatus('í•„í„°í•  ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
            const op = document.getElementById('filterOperator').value;
            const val = document.getElementById('filterValue').value;
            if (!val) { updateStatus('í•„í„° ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

            // ìˆ«ìí˜• ê°’ ìë™ ë³€í™˜
            const numVal = Number(val);
            const filterValue = !isNaN(numVal) && val.trim() !== '' ? numVal : val;

            updateStatus('â³ í•„í„° ì ìš© ì¤‘...');
            const start = performance.now();
            await sheet.filter([{ columnKey: col, operator: op, value: filterValue }]);
            const duration = performance.now() - start;
            updatePerf({ rowCount: `${sheet.getVisibleRowCount().toLocaleString()}ê±´` });
            updateStatus(`âœ… í•„í„° ì™„ë£Œ (${Math.round(duration)}ms) - ${sheet.getVisibleRowCount().toLocaleString()}ê±´ í‘œì‹œ`);
        };

        window.clearFilter = async function () {
            if (!sheet) return;
            updateStatus('â³ í•„í„° ì´ˆê¸°í™” ì¤‘...');
            const start = performance.now();
            await sheet.filter([]);
            const duration = performance.now() - start;
            updatePerf({ rowCount: `${sheet.getVisibleRowCount().toLocaleString()}ê±´` });
            updateStatus(`âœ… í•„í„° ì´ˆê¸°í™” (${Math.round(duration)}ms) - ${sheet.getVisibleRowCount().toLocaleString()}ê±´ í‘œì‹œ`);
            document.getElementById('filterValue').value = '';
        };

        // ì •ë ¬ ì ìš©
        window.applySort = async function () {
            if (!sheet) return;
            const col = document.getElementById('sortColumn').value;
            if (!col) { updateStatus('ì •ë ¬í•  ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
            const dir = document.getElementById('sortDirection').value;

            updateStatus('â³ ì •ë ¬ ì ìš© ì¤‘...');
            const start = performance.now();
            await sheet.sort([{ columnKey: col, direction: dir }]);
            const duration = performance.now() - start;
            updateStatus(`âœ… ì •ë ¬ ì™„ë£Œ (${Math.round(duration)}ms)`);
        };

        window.clearSort = async function () {
            if (!sheet) return;
            updateStatus('â³ ì •ë ¬ ì´ˆê¸°í™” ì¤‘...');
            const start = performance.now();
            await sheet.sort([]);
            const duration = performance.now() - start;
            updateStatus(`âœ… ì •ë ¬ ì´ˆê¸°í™” (${Math.round(duration)}ms)`);
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í˜ì¹­
        fetchFromApi().catch(console.error);
    </script>
</body>

</html>
