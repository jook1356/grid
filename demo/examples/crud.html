<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRUD & Undo/Redo - PureSheet Demo</title>
  <link rel="stylesheet" href="../shared/styles.css">
  <link rel="stylesheet" href="../../src/ui/style/default.css">
  <style>
    /* ë³€ê²½ì‚¬í•­ íŒ¨ë„ */
    .changes-panel {
      background: #f8f9fa;
      border: 1px solid var(--demo-border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .changes-panel h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .changes-summary {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .change-stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .change-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      padding: 0 8px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 13px;
    }

    .change-badge.added {
      background: rgba(76, 175, 80, 0.2);
      color: #2e7d32;
    }

    .change-badge.modified {
      background: rgba(255, 193, 7, 0.2);
      color: #f57c00;
    }

    .change-badge.deleted {
      background: rgba(244, 67, 54, 0.2);
      color: #c62828;
    }

    .change-badge.empty {
      background: #e0e0e0;
      color: #757575;
    }

    /* ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
    }

    .btn-commit {
      background: #4caf50 !important;
      color: white !important;
    }

    .btn-commit:hover {
      background: #388e3c !important;
    }

    .btn-commit:disabled {
      background: #a5d6a7 !important;
      cursor: not-allowed;
    }

    .btn-discard {
      background: #f44336 !important;
      color: white !important;
    }

    .btn-discard:hover {
      background: #d32f2f !important;
    }

    .btn-discard:disabled {
      background: #ef9a9a !important;
      cursor: not-allowed;
    }

    /* Undo/Redo ë²„íŠ¼ */
    .undo-redo-group {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .undo-redo-group button {
      padding: 6px 12px;
      font-size: 14px;
    }

    .undo-redo-group button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ë²”ë¡€ */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 12px 16px;
      background: #f9f9f9;
      border-bottom: 1px solid var(--demo-border);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ í‘œì‹œ */
    .shortcut-hint {
      font-size: 11px;
      color: #888;
      margin-left: 4px;
    }

    kbd {
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 1px 5px;
      font-size: 11px;
      font-family: monospace;
    }

    /* ì„ íƒëœ í–‰ ì •ë³´ */
    .selected-info {
      margin-top: 8px;
      padding: 8px 12px;
      background: #e3f2fd;
      border-radius: 4px;
      font-size: 13px;
      color: #1565c0;
    }

    /* ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ */
    #crudGrid {
      height: 450px;
    }
  </style>
</head>

<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="demo-nav">
    <a href="../index.html">ğŸ  í™ˆ</a>
    <a href="pinning.html">ğŸ“Œ í–‰/ì»¬ëŸ¼ ê³ ì •</a>
    <a href="multi-row.html">ğŸ“‘ Multi-Row</a>
    <a href="grouping.html">ğŸ“‚ í–‰ ê·¸ë£¹í™”</a>
    <a href="merge.html">ğŸ”— ì…€ ë³‘í•©</a>
    <a href="selection-modes.html">ğŸ¯ ì„ íƒ ëª¨ë“œ</a>
    <a href="pivot.html">ğŸ“Š í”¼ë²—</a>
    <a href="format-row.html">ğŸ¨ formatRow</a>
    <a href="crud.html" class="active">âœï¸ CRUD</a>
    <a href="column-visibility.html">ğŸ‘ï¸ í•„ë“œ ì„ íƒ</a>
  </nav>

  <!-- í—¤ë” -->
  <div class="demo-header">
    <h1>âœï¸ CRUD & Undo/Redo</h1>
    <span class="badge badge-implemented">êµ¬í˜„ë¨</span>
  </div>

  <!-- ì„¤ëª… -->
  <div class="demo-description">
    <p>
      <strong>Dirty State Pattern</strong>ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ì„ ì›ë³¸ì— ì¦‰ì‹œ ë°˜ì˜í•˜ì§€ ì•Šê³  pending ìƒíƒœë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
      <code>commitChanges()</code> í˜¸ì¶œ ì „ê¹Œì§€ ì›ë³¸ ë°ì´í„°ëŠ” ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©°,
      <code>discardChanges()</code>ë¡œ ëª¨ë“  ë³€ê²½ì„ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
    <p>
      <strong>Undo/Redo</strong>ëŠ” <kbd>Ctrl</kbd>+<kbd>Z</kbd> / <kbd>Ctrl</kbd>+<kbd>Y</kbd> ë‹¨ì¶•í‚¤ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
      ì…€ì„ <strong>ë”ë¸”í´ë¦­</strong>í•˜ë©´ ì¸ë¼ì¸ í¸ì§‘ ëª¨ë“œë¡œ ì§„ì…í•©ë‹ˆë‹¤.
    </p>
  </div>

  <!-- ë²”ë¡€ -->
  <div class="demo-container" style="margin-bottom: 20px;">
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4caf50;"></div>
        <span>ì¶”ê°€ëœ í–‰ (added)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107;"></div>
        <span>ìˆ˜ì •ëœ í–‰ (modified)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color"
          style="background: rgba(244, 67, 54, 0.1); border-left: 3px solid #f44336; text-decoration: line-through;">
        </div>
        <span>ì‚­ì œ ì˜ˆì • í–‰ (deleted)</span>
      </div>
    </div>
  </div>

  <!-- ë³€ê²½ì‚¬í•­ íŒ¨ë„ -->
  <div class="changes-panel">
    <h4>ğŸ“‹ Pending Changes (ì»¤ë°‹ ëŒ€ê¸° ì¤‘)</h4>
    <div class="changes-summary">
      <div class="change-stat">
        <span>ì¶”ê°€:</span>
        <span class="change-badge added" id="addedCount">0</span>
      </div>
      <div class="change-stat">
        <span>ìˆ˜ì •:</span>
        <span class="change-badge modified" id="modifiedCount">0</span>
      </div>
      <div class="change-stat">
        <span>ì‚­ì œ:</span>
        <span class="change-badge deleted" id="deletedCount">0</span>
      </div>
      <div class="change-stat" style="margin-left: auto;">
        <div class="undo-redo-group">
          <button onclick="handleUndo()" id="undoBtn" disabled title="Ctrl+Z">
            â†©ï¸ Undo
          </button>
          <button onclick="handleRedo()" id="redoBtn" disabled title="Ctrl+Y">
            â†ªï¸ Redo
          </button>
        </div>
      </div>
    </div>
    <div class="action-buttons">
      <button class="btn-commit" id="commitBtn" onclick="handleCommit()" disabled>
        âœ… Commit (ì›ë³¸ì— ë°˜ì˜)
      </button>
      <button class="btn-discard" id="discardBtn" onclick="handleDiscard()" disabled>
        âŒ Discard (ë³€ê²½ ì·¨ì†Œ)
      </button>
    </div>
  </div>

  <!-- ê·¸ë¦¬ë“œ ì˜ì—­ -->
  <div class="demo-container">
    <div class="toolbar">
      <div class="toolbar-group">
        <button onclick="addNewRow()">â• í–‰ ì¶”ê°€</button>
        <button onclick="deleteSelectedRows()" class="danger">ğŸ—‘ï¸ ì„ íƒ í–‰ ì‚­ì œ</button>
      </div>
      <div class="toolbar-divider"></div>
      <div class="toolbar-group">
        <button onclick="modifySelectedRow()" class="secondary">âœï¸ ì„ íƒ í–‰ ìˆ˜ì • (ê°€ê²©+100)</button>
        <button onclick="restoreSelectedRow()" class="secondary">â†©ï¸ ì„ íƒ í–‰ ë³µì›</button>
      </div>
      <div class="toolbar-divider"></div>
      <div class="toolbar-group">
        <span class="shortcut-hint">
          ë‹¨ì¶•í‚¤: <kbd>Ctrl</kbd>+<kbd>Z</kbd> Undo, <kbd>Ctrl</kbd>+<kbd>Y</kbd> Redo
        </span>
      </div>
    </div>
    <div id="crudGrid"></div>
    <div class="status-bar" id="statusBar">ì´ˆê¸°í™” ì¤‘...</div>
    <div class="selected-info" id="selectedInfo" style="display: none;"></div>
  </div>

  <!-- ì½”ë“œ ì˜ˆì œ -->
  <div class="code-example">
    <h3>CRUD & Undo/Redo API ì‚¬ìš©ë²•</h3>
    <pre><span class="comment">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="comment">// Dirty State CRUD API</span>
<span class="comment">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>

<span class="comment">// 1. í–‰ ì¶”ê°€ (pending)</span>
<span class="keyword">const</span> newId = grid.<span class="function">addRowDirty</span>({
  name: <span class="string">'í™ê¸¸ë™'</span>,
  department: <span class="string">'ê°œë°œíŒ€'</span>,
  salary: <span class="number">4500</span>,
});
<span class="comment">// â†’ ps-row-added í´ë˜ìŠ¤ ìë™ ì ìš©</span>

<span class="comment">// 2. ì…€ ê°’ ìˆ˜ì • (pending)</span>
grid.<span class="function">updateCellDirty</span>(<span class="string">'row-5'</span>, <span class="string">'salary'</span>, <span class="number">5000</span>);
<span class="comment">// â†’ ps-row-modified í´ë˜ìŠ¤ ìë™ ì ìš©</span>

<span class="comment">// 3. í–‰ ì‚­ì œ (pending)</span>
grid.<span class="function">deleteRowDirty</span>(<span class="string">'row-3'</span>);
<span class="comment">// â†’ ps-row-deleted í´ë˜ìŠ¤ ìë™ ì ìš©</span>

<span class="comment">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="comment">// Undo/Redo API</span>
<span class="comment">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>

<span class="comment">// Undo (Ctrl+Z)</span>
grid.<span class="function">undo</span>();

<span class="comment">// Redo (Ctrl+Y)</span>
grid.<span class="function">redo</span>();

<span class="comment">// ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸</span>
<span class="keyword">if</span> (grid.<span class="property">canUndo</span>) { <span class="comment">/* ... */</span> }
<span class="keyword">if</span> (grid.<span class="property">canRedo</span>) { <span class="comment">/* ... */</span> }

<span class="comment">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="comment">// Dirty State ì¡°íšŒ ë° ì»¤ë°‹</span>
<span class="comment">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>

<span class="comment">// ë³€ê²½ì‚¬í•­ ì¡´ì¬ ì—¬ë¶€</span>
<span class="keyword">if</span> (grid.<span class="property">hasChanges</span>) {
  <span class="comment">// ë³€ê²½ì‚¬í•­ ì¡°íšŒ</span>
  <span class="keyword">const</span> changes = grid.<span class="function">getChanges</span>();
  <span class="keyword">console</span>.log(changes.added);    <span class="comment">// ì¶”ê°€ëœ í–‰ë“¤</span>
  <span class="keyword">console</span>.log(changes.modified); <span class="comment">// ìˆ˜ì •ëœ í–‰ë“¤</span>
  <span class="keyword">console</span>.log(changes.deleted);  <span class="comment">// ì‚­ì œëœ í–‰ë“¤</span>
}

<span class="comment">// ì»¤ë°‹ (ì›ë³¸ì— ë°˜ì˜)</span>
<span class="keyword">await</span> grid.<span class="function">commitChanges</span>();
<span class="comment">// â†’ ëª¨ë“  dirty í´ë˜ìŠ¤ ì œê±°, Undo ìŠ¤íƒ ì´ˆê¸°í™”</span>

<span class="comment">// íê¸° (ë³€ê²½ ì·¨ì†Œ)</span>
grid.<span class="function">discardChanges</span>();
<span class="comment">// â†’ ëª¨ë“  pending ë³€ê²½ ì·¨ì†Œ, Undo ìŠ¤íƒ ì´ˆê¸°í™”</span>

<span class="comment">// íŠ¹ì • í–‰ë§Œ íê¸°</span>
grid.<span class="function">discardRow</span>(<span class="string">'row-5'</span>);</pre>
  </div>

  <script type="module">
    import { PureSheet } from '../../src/index.ts';

    let grid = null;
    let nextId = 100;

    // =========================================================================
    // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
    // =========================================================================

    const departments = ['ê°œë°œíŒ€', 'ê¸°íšíŒ€', 'ë””ìì¸íŒ€', 'ë§ˆì¼€íŒ…íŒ€', 'ì¸ì‚¬íŒ€'];
    const statuses = ['ì¬ì§', 'íœ´ì§', 'í‡´ì‚¬ì˜ˆì •'];
    const names = ['ê¹€ì² ìˆ˜', 'ì´ì˜í¬', 'ë°•ì§€ë¯¼', 'ìµœìˆ˜ì§„', 'ì •ë¯¼í˜¸', 'ê°•ì„œì—°', 'ìœ¤ë„í˜„', 'ì„ì§€ì€'];

    function generateData() {
      const data = [];
      for (let i = 1; i <= 30; i++) {
        data.push({
          id: i,
          name: names[Math.floor(Math.random() * names.length)] + i,
          department: departments[Math.floor(Math.random() * departments.length)],
          salary: Math.floor(Math.random() * 3000) + 3000,
          status: statuses[Math.floor(Math.random() * statuses.length)],
          joinDate: `2020-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-01`,
        });
      }
      return data;
    }

    // =========================================================================
    // ì´ˆê¸°í™”
    // =========================================================================

    async function init() {
      const container = document.getElementById('crudGrid');
      const data = generateData();

      const fields = [
        { key: 'id', header: 'ID', dataType: 'number', width: 60, readonly: true },
        { key: 'name', header: 'ì´ë¦„', dataType: 'string', width: 120 },
        { key: 'department', header: 'ë¶€ì„œ', dataType: 'string', width: 100 },
        { key: 'salary', header: 'ê¸‰ì—¬', dataType: 'number', width: 100 },
        { key: 'status', header: 'ìƒíƒœ', dataType: 'string', width: 90 },
        { key: 'joinDate', header: 'ì…ì‚¬ì¼', dataType: 'string', width: 110 },
      ];

      grid = new PureSheet(container, {
        mode: 'flat',
        fields,
        data,
        idKey: 'id',
        selectionMode: 'row',
        editable: true, // ë”ë¸”í´ë¦­ ì¸ë¼ì¸ í¸ì§‘ í™œì„±í™”
        theme: 'light',
      });

      // ì„ íƒ ì´ë²¤íŠ¸
      grid.on('selection:changed', () => {
        updateSelectedInfo();
      });

      // Undo/Redo ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ (ë‹¨ì¶•í‚¤, ë²„íŠ¼ ëª¨ë‘ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
      grid.on('undo:stateChange', () => {
        updateChangesPanel();
        updateUndoRedoButtons();
      });

      updateStatus('ì¤€ë¹„ ì™„ë£Œ - ì…€ì„ ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘, Ctrl+Zë¡œ Undo');
      updateChangesPanel();
    }

    // =========================================================================
    // CRUD í•¨ìˆ˜ë“¤
    // =========================================================================

    window.addNewRow = function () {
      if (!grid) return;

      const newRow = {
        id: ++nextId,
        name: `ì‹ ì…ì‚¬ì› ${nextId}`,
        department: departments[Math.floor(Math.random() * departments.length)],
        salary: Math.floor(Math.random() * 2000) + 3000,
        status: 'ì¬ì§',
        joinDate: new Date().toISOString().split('T')[0],
      };

      grid.addRowDirty(newRow);
      updateChangesPanel();
      updateUndoRedoButtons();
      updateStatus(`í–‰ ì¶”ê°€ë¨ (ID: ${nextId}) - Undo ê°€ëŠ¥`);
    };

    window.deleteSelectedRows = function () {
      if (!grid) return;

      const selectedIds = grid.getSelectedRowIds();
      if (selectedIds.length === 0) {
        alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
      }

      // Batchë¡œ ë¬¶ì–´ì„œ Ctrl+Z í•œ ë²ˆì— ì „ì²´ ë³µì› ê°€ëŠ¥
      grid.beginBatch(`${selectedIds.length}ê°œ í–‰ ì‚­ì œ`);
      for (const id of selectedIds) {
        grid.deleteRowDirty(id);
      }
      grid.endBatch();

      grid.clearSelection();
      updateChangesPanel();
      updateUndoRedoButtons();
      updateStatus(`${selectedIds.length}ê°œ í–‰ ì‚­ì œ ì˜ˆì • - Undo 1ë²ˆìœ¼ë¡œ ì „ì²´ ë³µì› ê°€ëŠ¥`);
    };

    window.modifySelectedRow = function () {
      if (!grid) return;

      const selectedIds = grid.getSelectedRowIds();
      if (selectedIds.length === 0) {
        alert('ìˆ˜ì •í•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
      }

      // Batchë¡œ ë¬¶ì–´ì„œ Ctrl+Z í•œ ë²ˆì— ì „ì²´ ë˜ëŒë¦¬ê¸° ê°€ëŠ¥
      grid.beginBatch(`${selectedIds.length}ê°œ í–‰ ê¸‰ì—¬ ìˆ˜ì •`);
      for (const id of selectedIds) {
        // í˜„ì¬ salary ê°’ì„ ê°€ì ¸ì™€ì„œ +100
        const rowData = grid.getRowById(id);
        if (rowData) {
          const currentSalary = rowData.salary ?? 0;
          grid.updateCellDirty(id, 'salary', currentSalary + 100);
        }
      }
      grid.endBatch();

      updateChangesPanel();
      updateUndoRedoButtons();
      updateStatus(`${selectedIds.length}ê°œ í–‰ ê¸‰ì—¬ +100 ìˆ˜ì •ë¨ - Undo 1ë²ˆìœ¼ë¡œ ì „ì²´ ë³µì› ê°€ëŠ¥`);
    };

    window.restoreSelectedRow = function () {
      if (!grid) return;

      const selectedIds = grid.getSelectedRowIds();
      if (selectedIds.length === 0) {
        alert('ë³µì›í•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
      }

      // Batchë¡œ ë¬¶ì–´ì„œ Ctrl+Z í•œ ë²ˆì— ì „ì²´ ë‹¤ì‹œ ì‚­ì œ ê°€ëŠ¥
      grid.beginBatch(`${selectedIds.length}ê°œ í–‰ ë³µì›`);
      for (const id of selectedIds) {
        grid.discardRowDirty(id);  // Undo ì§€ì›ë˜ëŠ” íê¸° ë©”ì„œë“œ
      }
      grid.endBatch();

      updateChangesPanel();
      updateUndoRedoButtons();
      updateStatus(`${selectedIds.length}ê°œ í–‰ ë³€ê²½ì‚¬í•­ ë³µì›ë¨ - Undo 1ë²ˆìœ¼ë¡œ ì „ì²´ ì·¨ì†Œ ê°€ëŠ¥`);
    };

    // =========================================================================
    // Undo/Redo
    // =========================================================================

    window.handleUndo = function () {
      if (!grid) return;

      if (grid.undo()) {
        updateStatus('Undo ì‹¤í–‰ë¨');
      }
    };

    window.handleRedo = function () {
      if (!grid) return;

      if (grid.redo()) {
        updateStatus('Redo ì‹¤í–‰ë¨');
      }
    };

    function updateUndoRedoButtons() {
      if (!grid) return;

      document.getElementById('undoBtn').disabled = !grid.canUndo;
      document.getElementById('redoBtn').disabled = !grid.canRedo;
    }

    // =========================================================================
    // Commit/Discard
    // =========================================================================

    window.handleCommit = async function () {
      if (!grid || !grid.hasChanges) return;

      const changes = grid.getChanges();
      const summary = `ì¶”ê°€: ${changes.added.length}, ìˆ˜ì •: ${changes.modified.length}, ì‚­ì œ: ${changes.deleted.length}`;

      if (confirm(`ë‹¤ìŒ ë³€ê²½ì‚¬í•­ì„ ì›ë³¸ì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${summary}`)) {
        await grid.commitChanges();
        updateChangesPanel();
        updateUndoRedoButtons();
        updateStatus('ë³€ê²½ì‚¬í•­ì´ ì›ë³¸ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    };

    window.handleDiscard = function () {
      if (!grid || !grid.hasChanges) return;

      if (confirm('ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        grid.discardChanges();
        updateChangesPanel();
        updateUndoRedoButtons();
        updateStatus('ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    };

    // =========================================================================
    // UI ì—…ë°ì´íŠ¸
    // =========================================================================

    function updateChangesPanel() {
      if (!grid) return;

      const changes = grid.getChanges();
      const addedCount = changes.added.length;
      const modifiedCount = changes.modified.length;
      const deletedCount = changes.deleted.length;
      const hasChanges = addedCount + modifiedCount + deletedCount > 0;

      // ë°°ì§€ ì—…ë°ì´íŠ¸
      document.getElementById('addedCount').textContent = addedCount;
      document.getElementById('addedCount').className =
        `change-badge ${addedCount > 0 ? 'added' : 'empty'}`;

      document.getElementById('modifiedCount').textContent = modifiedCount;
      document.getElementById('modifiedCount').className =
        `change-badge ${modifiedCount > 0 ? 'modified' : 'empty'}`;

      document.getElementById('deletedCount').textContent = deletedCount;
      document.getElementById('deletedCount').className =
        `change-badge ${deletedCount > 0 ? 'deleted' : 'empty'}`;

      // ë²„íŠ¼ í™œì„±í™”
      document.getElementById('commitBtn').disabled = !hasChanges;
      document.getElementById('discardBtn').disabled = !hasChanges;
    }

    function updateStatus(message) {
      document.getElementById('statusBar').textContent = message;
    }

    function updateSelectedInfo() {
      if (!grid) return;

      const selectedIds = grid.getSelectedRowIds();
      const infoEl = document.getElementById('selectedInfo');

      if (selectedIds.length === 0) {
        infoEl.style.display = 'none';
        return;
      }

      // ì„ íƒëœ í–‰ì˜ ìƒíƒœ í‘œì‹œ
      const stateInfos = selectedIds.slice(0, 5).map(id => {
        const state = grid.getRowState(id);
        return `ID ${id}: ${state}`;
      });

      if (selectedIds.length > 5) {
        stateInfos.push(`... ì™¸ ${selectedIds.length - 5}ê°œ`);
      }

      infoEl.style.display = 'block';
      infoEl.innerHTML = `
        <strong>ì„ íƒëœ í–‰:</strong> ${selectedIds.length}ê°œ
        <br>
        <strong>ìƒíƒœ:</strong> ${stateInfos.join(', ')}
      `;
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    init().catch(console.error);
  </script>
</body>

</html>