<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DuckDB-Wasm vs Arquero ë²¤ì¹˜ë§ˆí¬ v2 (Web Worker)</title>
  <link rel="stylesheet" href="../shared/styles.css" />
  <style>
    .benchmark-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .controls label {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .controls select, .controls input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .controls button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .controls button:hover {
      background: #0056b3;
    }

    .controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      margin: 0 0 10px 0;
      color: #0056b3;
    }

    .info-box ul {
      margin: 0;
      padding-left: 20px;
    }

    .results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .result-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
    }

    .result-card h3 {
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #007bff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .result-card.arquero h3 {
      border-bottom-color: #28a745;
    }

    .result-card.duckdb h3 {
      border-bottom-color: #dc3545;
    }

    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #6c757d;
      color: white;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: #666;
    }

    .metric-value {
      font-weight: bold;
      font-family: monospace;
    }

    .metric-value.faster {
      color: #28a745;
    }

    .metric-value.slower {
      color: #dc3545;
    }

    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      background: #e9ecef;
    }

    .status.loading {
      background: #fff3cd;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 12px;
      text-align: left;
      border: 1px solid #dee2e6;
    }

    .comparison-table th {
      background: #f8f9fa;
    }

    .comparison-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    .winner {
      background: #d4edda !important;
      font-weight: bold;
    }

    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin: 2px 0;
    }

    .log-entry.info { color: #9cdcfe; }
    .log-entry.success { color: #6a9955; }
    .log-entry.error { color: #f14c4c; }
    .log-entry.time { color: #dcdcaa; }
    .log-entry.transfer { color: #ce9178; }
  </style>
</head>
<body>
  <div class="benchmark-container">
    <h1>ğŸ¦† DuckDB-Wasm vs ğŸ“Š Arquero ë²¤ì¹˜ë§ˆí¬ v2</h1>
    <p>Web Worker ê¸°ë°˜ ê³µì • ë¹„êµ (ë¬¸ì„œ 020 ìµœì í™” ê¸°ë²• ì ìš©)</p>

    <div class="info-box">
      <h3>ğŸ”§ ì ìš©ëœ ìµœì í™” ê¸°ë²•</h3>
      <ul>
        <li><strong>Web Worker</strong>: ë‘˜ ë‹¤ Workerì—ì„œ ì‹¤í–‰ (UI ë¸”ë¡œí‚¹ ë°©ì§€)</li>
        <li><strong>Arquero</strong>: Structured Cloneìœ¼ë¡œ JS ë°°ì—´ ì „ì†¡</li>
        <li><strong>DuckDB</strong>: Arrow IPC + Transferable (Zero-copy ì „ì†¡)</li>
        <li><strong>Projection Pushdown</strong>: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ SELECT</li>
        <li><strong>ê²°ê³¼ ìµœì†Œí™”</strong>: ì§‘ê³„ê°’/COUNTë§Œ ë°˜í™˜ (ëŒ€ëŸ‰ ë°ì´í„° ë°˜í™˜ X)</li>
      </ul>
    </div>

    <div class="controls">
      <label>
        ë°ì´í„° ê±´ìˆ˜:
        <select id="rowCount">
          <option value="100000">100,000ê±´</option>
          <option value="500000">500,000ê±´</option>
          <option value="1000000" selected>1,000,000ê±´</option>
          <option value="5000000">5,000,000ê±´</option>
        </select>
      </label>

      <label>
        ì»¬ëŸ¼ ìˆ˜:
        <select id="colCount">
          <option value="10" selected>10ê°œ</option>
          <option value="20">20ê°œ</option>
        </select>
      </label>

      <button id="runBenchmark">ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰</button>
      <button id="clearResults">ê²°ê³¼ ì´ˆê¸°í™”</button>
    </div>

    <div id="status" class="status">ì¤€ë¹„ë¨. ë²¤ì¹˜ë§ˆí¬ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</div>

    <div class="results" id="results" style="display: none;">
      <div class="result-card arquero">
        <h3>
          ğŸ“Š Arquero
          <span class="badge">Structured Clone</span>
        </h3>
        <div id="arqueroResults"></div>
      </div>

      <div class="result-card duckdb">
        <h3>
          ğŸ¦† DuckDB-Wasm
          <span class="badge">Arrow Zero-copy</span>
        </h3>
        <div id="duckdbResults"></div>
      </div>
    </div>

    <table class="comparison-table" id="comparisonTable" style="display: none;">
      <thead>
        <tr>
          <th>í…ŒìŠ¤íŠ¸</th>
          <th>Arquero</th>
          <th>DuckDB-Wasm</th>
          <th>ë¹„ìœ¨</th>
        </tr>
      </thead>
      <tbody id="comparisonBody"></tbody>
    </table>

    <div id="pivotResults" class="result-card" style="display: none; margin-top: 20px; background: #fff3cd; border-color: #ffc107;">
      <!-- í”¼ë²—+ë¶€ë¶„í•© ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
    </div>

    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import * as arrow from 'apache-arrow';

    // UI ìš”ì†Œ
    const rowCountSelect = document.getElementById('rowCount');
    const colCountSelect = document.getElementById('colCount');
    const runBtn = document.getElementById('runBenchmark');
    const clearBtn = document.getElementById('clearResults');
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    const arqueroResultsDiv = document.getElementById('arqueroResults');
    const duckdbResultsDiv = document.getElementById('duckdbResults');
    const comparisonTable = document.getElementById('comparisonTable');
    const comparisonBody = document.getElementById('comparisonBody');
    const logDiv = document.getElementById('log');

    // Workers
    let arqueroWorker = null;
    let duckdbWorker = null;

    // ë¡œê·¸
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setStatus(message, type = '') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± (ë©”ì¸ ìŠ¤ë ˆë“œ)
    function generateData(rowCount, colCount) {
      log(`ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ë°ì´í„° ìƒì„± ì¤‘: ${rowCount.toLocaleString()}ê±´, ${colCount}ì»¬ëŸ¼`);
      const startTime = performance.now();

      const regions = ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…'];
      const products = ['ë…¸íŠ¸ë¶', 'ìŠ¤ë§ˆíŠ¸í°', 'íƒœë¸”ë¦¿', 'ëª¨ë‹ˆí„°', 'í‚¤ë³´ë“œ', 'ë§ˆìš°ìŠ¤', 'ì´ì–´í°', 'ìŠ¤í”¼ì»¤'];
      const categories = ['ì „ìì œí’ˆ', 'ìƒí™œìš©í’ˆ', 'ì˜ë¥˜', 'ì‹í’ˆ'];

      const data = [];
      for (let i = 0; i < rowCount; i++) {
        const row = {
          id: i + 1,
          region: regions[Math.floor(Math.random() * regions.length)],
          product: products[Math.floor(Math.random() * products.length)],
          category: categories[Math.floor(Math.random() * categories.length)],
          amount: Math.round(Math.random() * 100000) / 100,
          quantity: Math.floor(Math.random() * 100) + 1,
          year: 2020 + Math.floor(Math.random() * 5),
          month: Math.floor(Math.random() * 12) + 1,
          discount: Math.round(Math.random() * 30) / 100,
          isActive: Math.random() > 0.3
        };

        for (let j = 10; j < colCount; j++) {
          row[`col${j}`] = Math.round(Math.random() * 1000);
        }

        data.push(row);
      }

      const genTime = performance.now() - startTime;
      log(`ë°ì´í„° ìƒì„± ì™„ë£Œ: ${genTime.toFixed(0)}ms`, 'success');
      return { data, genTime };
    }

    // JS ë°°ì—´ â†’ Arrow IPC ë³€í™˜ (ë©”ì¸ ìŠ¤ë ˆë“œ)
    function convertToArrowIPC(data) {
      log('Arrow IPC ë³€í™˜ ì¤‘...');
      const startTime = performance.now();

      const firstRow = data[0];
      const columns = Object.keys(firstRow);
      const columnData = {};

      for (const col of columns) {
        columnData[col] = data.map(row => row[col]);
      }

      const arrowTable = arrow.tableFromArrays(columnData);
      const ipcBytes = arrow.tableToIPC(arrowTable, 'stream');

      const convertTime = performance.now() - startTime;
      log(`Arrow IPC ë³€í™˜ ì™„ë£Œ: ${convertTime.toFixed(0)}ms (${(ipcBytes.byteLength / 1024 / 1024).toFixed(1)}MB)`, 'transfer');

      return { ipcBytes, convertTime };
    }

    // Worker ë©”ì‹œì§€ ëŒ€ê¸° í—¬í¼
    function waitForMessage(worker, expectedType) {
      return new Promise((resolve, reject) => {
        const handler = (e) => {
          if (e.data.type === expectedType) {
            worker.removeEventListener('message', handler);
            resolve(e.data);
          } else if (e.data.type === 'ERROR') {
            worker.removeEventListener('message', handler);
            reject(new Error(e.data.message));
          }
        };
        worker.addEventListener('message', handler);
      });
    }

    // Workers ì´ˆê¸°í™”
    async function initWorkers() {
      log('Workers ì´ˆê¸°í™” ì¤‘...');

      // Arquero Worker
      arqueroWorker = new Worker(
        new URL('../workers/arqueroWorker.ts', import.meta.url),
        { type: 'module' }
      );
      arqueroWorker.postMessage({ type: 'INIT' });
      await waitForMessage(arqueroWorker, 'INIT_COMPLETE');
      log('Arquero Worker ì¤€ë¹„ ì™„ë£Œ', 'success');

      // DuckDB Worker
      duckdbWorker = new Worker(
        new URL('../workers/duckdbWorker.ts', import.meta.url),
        { type: 'module' }
      );
      duckdbWorker.postMessage({ type: 'INIT' });
      await waitForMessage(duckdbWorker, 'INIT_COMPLETE');
      log('DuckDB Worker ì¤€ë¹„ ì™„ë£Œ', 'success');
    }

    // Arquero ë²¤ì¹˜ë§ˆí¬
    async function runArqueroBenchmarks(data) {
      log('=== Arquero ë²¤ì¹˜ë§ˆí¬ ì‹œì‘ ===', 'info');
      const results = {};

      // ë°ì´í„° ì „ì†¡ (Structured Clone)
      const transferStart = performance.now();
      arqueroWorker.postMessage({ type: 'LOAD_DATA', data });
      const loadResult = await waitForMessage(arqueroWorker, 'LOAD_COMPLETE');
      results.transfer = performance.now() - transferStart;
      results.load = loadResult.loadTime;
      log(`[Arquero] ì „ì†¡(Structured Clone): ${results.transfer.toFixed(2)}ms`, 'transfer');
      log(`[Arquero] Worker ë‚´ ë¡œë“œ: ${results.load.toFixed(2)}ms`, 'time');

      // 1. í•„í„°
      arqueroWorker.postMessage({ type: 'FILTER', id: 'filter' });
      const filterResult = await waitForMessage(arqueroWorker, 'QUERY_RESULT');
      results.filter = filterResult.queryTime;
      log(`[Arquero] í•„í„°: ${results.filter.toFixed(2)}ms (${filterResult.rowCount.toLocaleString()}ê±´)`, 'time');

      // 2. ì •ë ¬
      arqueroWorker.postMessage({ type: 'SORT', id: 'sort' });
      const sortResult = await waitForMessage(arqueroWorker, 'QUERY_RESULT');
      results.sort = sortResult.queryTime;
      log(`[Arquero] ì •ë ¬: ${results.sort.toFixed(2)}ms`, 'time');

      // 3. ê·¸ë£¹ ì§‘ê³„
      arqueroWorker.postMessage({ type: 'AGGREGATE', id: 'aggregate' });
      const aggResult = await waitForMessage(arqueroWorker, 'QUERY_RESULT');
      results.aggregate = aggResult.queryTime;
      log(`[Arquero] ê·¸ë£¹ ì§‘ê³„: ${results.aggregate.toFixed(2)}ms`, 'time');

      // 4. í”¼ë²—
      arqueroWorker.postMessage({ type: 'PIVOT', id: 'pivot' });
      const pivotResult = await waitForMessage(arqueroWorker, 'QUERY_RESULT');
      results.pivot = pivotResult.queryTime;
      log(`[Arquero] í”¼ë²—: ${results.pivot.toFixed(2)}ms`, 'time');

      // 5. ë³µí•© ì¿¼ë¦¬
      arqueroWorker.postMessage({ type: 'COMPLEX', id: 'complex' });
      const complexResult = await waitForMessage(arqueroWorker, 'QUERY_RESULT');
      results.complex = complexResult.queryTime;
      log(`[Arquero] ë³µí•© ì¿¼ë¦¬: ${results.complex.toFixed(2)}ms`, 'time');

      results.totalQuery = results.filter + results.sort + results.aggregate + results.pivot + results.complex;
      results.totalWithTransfer = results.transfer + results.totalQuery;
      log(`[Arquero] ìˆœìˆ˜ ì¿¼ë¦¬ ì‹œê°„: ${results.totalQuery.toFixed(2)}ms`, 'success');
      log(`[Arquero] ì „ì†¡ í¬í•¨ ì´í•©: ${results.totalWithTransfer.toFixed(2)}ms`, 'success');

      return results;
    }

    // DuckDB ë²¤ì¹˜ë§ˆí¬
    async function runDuckDBBenchmarks(data) {
      log('=== DuckDB-Wasm ë²¤ì¹˜ë§ˆí¬ ì‹œì‘ ===', 'info');
      const results = {};

      // Arrow ë³€í™˜ (ë©”ì¸ ìŠ¤ë ˆë“œ)
      const { ipcBytes, convertTime } = convertToArrowIPC(data);
      results.arrowConvert = convertTime;

      // ë°ì´í„° ì „ì†¡ (Transferable - Zero-copy)
      const transferStart = performance.now();
      duckdbWorker.postMessage(
        { type: 'LOAD_DATA', arrowIPC: ipcBytes },
        [ipcBytes.buffer]  // Transferable!
      );
      const loadResult = await waitForMessage(duckdbWorker, 'LOAD_COMPLETE');
      results.transfer = performance.now() - transferStart;
      results.load = loadResult.loadTime;
      log(`[DuckDB] Arrow ë³€í™˜: ${results.arrowConvert.toFixed(2)}ms`, 'transfer');
      log(`[DuckDB] ì „ì†¡(Transferable): ${results.transfer.toFixed(2)}ms`, 'transfer');
      log(`[DuckDB] Worker ë‚´ ë¡œë“œ: ${results.load.toFixed(2)}ms`, 'time');

      // 1. í•„í„°
      duckdbWorker.postMessage({ type: 'FILTER', id: 'filter' });
      const filterResult = await waitForMessage(duckdbWorker, 'QUERY_RESULT');
      results.filter = filterResult.queryTime;
      log(`[DuckDB] í•„í„°: ${results.filter.toFixed(2)}ms (${filterResult.rowCount.toLocaleString()}ê±´)`, 'time');

      // 2. ì •ë ¬
      duckdbWorker.postMessage({ type: 'SORT', id: 'sort' });
      const sortResult = await waitForMessage(duckdbWorker, 'QUERY_RESULT');
      results.sort = sortResult.queryTime;
      log(`[DuckDB] ì •ë ¬: ${results.sort.toFixed(2)}ms`, 'time');

      // 3. ê·¸ë£¹ ì§‘ê³„
      duckdbWorker.postMessage({ type: 'AGGREGATE', id: 'aggregate' });
      const aggResult = await waitForMessage(duckdbWorker, 'QUERY_RESULT');
      results.aggregate = aggResult.queryTime;
      log(`[DuckDB] ê·¸ë£¹ ì§‘ê³„: ${results.aggregate.toFixed(2)}ms`, 'time');

      // 4. í”¼ë²—
      duckdbWorker.postMessage({ type: 'PIVOT', id: 'pivot' });
      const pivotResult = await waitForMessage(duckdbWorker, 'QUERY_RESULT');
      results.pivot = pivotResult.queryTime;
      log(`[DuckDB] í”¼ë²—: ${results.pivot.toFixed(2)}ms`, 'time');

      // 5. ë³µí•© ì¿¼ë¦¬
      duckdbWorker.postMessage({ type: 'COMPLEX', id: 'complex' });
      const complexResult = await waitForMessage(duckdbWorker, 'QUERY_RESULT');
      results.complex = complexResult.queryTime;
      log(`[DuckDB] ë³µí•© ì¿¼ë¦¬: ${results.complex.toFixed(2)}ms`, 'time');

      results.totalQuery = results.filter + results.sort + results.aggregate + results.pivot + results.complex;
      results.totalWithTransfer = results.arrowConvert + results.transfer + results.totalQuery;
      log(`[DuckDB] ìˆœìˆ˜ ì¿¼ë¦¬ ì‹œê°„: ${results.totalQuery.toFixed(2)}ms`, 'success');
      log(`[DuckDB] ë³€í™˜+ì „ì†¡ í¬í•¨ ì´í•©: ${results.totalWithTransfer.toFixed(2)}ms`, 'success');

      return results;
    }

    // ê²°ê³¼ í‘œì‹œ
    function displayResults(arqueroRes, duckdbRes) {
      resultsDiv.style.display = 'grid';
      comparisonTable.style.display = 'table';

      const formatMetric = (label, value, unit = 'ms') => `
        <div class="metric">
          <span class="metric-label">${label}</span>
          <span class="metric-value">${value.toFixed(2)}${unit}</span>
        </div>
      `;

      arqueroResultsDiv.innerHTML = `
        ${formatMetric('ì „ì†¡ (Structured Clone)', arqueroRes.transfer)}
        ${formatMetric('Worker ë‚´ ë¡œë“œ', arqueroRes.load)}
        <hr style="margin: 10px 0; border: none; border-top: 1px dashed #ccc;">
        ${formatMetric('í•„í„°', arqueroRes.filter)}
        ${formatMetric('ì •ë ¬', arqueroRes.sort)}
        ${formatMetric('ê·¸ë£¹ ì§‘ê³„', arqueroRes.aggregate)}
        ${formatMetric('í”¼ë²—', arqueroRes.pivot)}
        ${formatMetric('ë³µí•© ì¿¼ë¦¬', arqueroRes.complex)}
        <hr style="margin: 10px 0; border: none; border-top: 1px dashed #ccc;">
        ${formatMetric('ìˆœìˆ˜ ì¿¼ë¦¬ í•©ê³„', arqueroRes.totalQuery)}
        ${formatMetric('ì „ì†¡ í¬í•¨ ì´í•©', arqueroRes.totalWithTransfer)}
      `;

      duckdbResultsDiv.innerHTML = `
        ${formatMetric('Arrow ë³€í™˜', duckdbRes.arrowConvert)}
        ${formatMetric('ì „ì†¡ (Transferable)', duckdbRes.transfer)}
        ${formatMetric('Worker ë‚´ ë¡œë“œ', duckdbRes.load)}
        <hr style="margin: 10px 0; border: none; border-top: 1px dashed #ccc;">
        ${formatMetric('í•„í„°', duckdbRes.filter)}
        ${formatMetric('ì •ë ¬', duckdbRes.sort)}
        ${formatMetric('ê·¸ë£¹ ì§‘ê³„', duckdbRes.aggregate)}
        ${formatMetric('í”¼ë²—', duckdbRes.pivot)}
        ${formatMetric('ë³µí•© ì¿¼ë¦¬', duckdbRes.complex)}
        <hr style="margin: 10px 0; border: none; border-top: 1px dashed #ccc;">
        ${formatMetric('ìˆœìˆ˜ ì¿¼ë¦¬ í•©ê³„', duckdbRes.totalQuery)}
        ${formatMetric('ë³€í™˜+ì „ì†¡ í¬í•¨ ì´í•©', duckdbRes.totalWithTransfer)}
      `;

      // ë¹„êµ í…Œì´ë¸”
      const tests = [
        ['ë°ì´í„° ì „ì†¡', 'transfer', 'transfer'],
        ['Worker ë‚´ ë¡œë“œ', 'load', 'load'],
        ['í•„í„°', 'filter', 'filter'],
        ['ì •ë ¬', 'sort', 'sort'],
        ['ê·¸ë£¹ ì§‘ê³„', 'aggregate', 'aggregate'],
        ['í”¼ë²—', 'pivot', 'pivot'],
        ['ë³µí•© ì¿¼ë¦¬', 'complex', 'complex'],
        ['ìˆœìˆ˜ ì¿¼ë¦¬ í•©ê³„', 'totalQuery', 'totalQuery'],
        ['ì „ì²´ ì´í•©', 'totalWithTransfer', 'totalWithTransfer']
      ];

      comparisonBody.innerHTML = tests.map(([label, aqKey, duckKey]) => {
        const aqVal = arqueroRes[aqKey];
        const duckVal = duckdbRes[duckKey];
        const ratio = aqVal / duckVal;
        const aqWinner = aqVal < duckVal;
        const duckWinner = duckVal < aqVal;

        let ratioText;
        if (ratio > 1) {
          ratioText = `ğŸ¦† DuckDB ${ratio.toFixed(1)}ë°° ë¹ ë¦„`;
        } else if (ratio < 1) {
          ratioText = `ğŸ“Š Arquero ${(1/ratio).toFixed(1)}ë°° ë¹ ë¦„`;
        } else {
          ratioText = 'ë™ì¼';
        }

        return `
          <tr>
            <td>${label}</td>
            <td class="${aqWinner ? 'winner' : ''}">${aqVal.toFixed(2)}ms</td>
            <td class="${duckWinner ? 'winner' : ''}">${duckVal.toFixed(2)}ms</td>
            <td>${ratioText}</td>
          </tr>
        `;
      }).join('');
    }

    // ========================================
    // í”¼ë²— + ë¶€ë¶„í•© + í•„í„° ë°˜ë³µ ì‹œë‚˜ë¦¬ì˜¤
    // ========================================

    // í•„í„° ì¡°ê±´ë“¤ (ì¹´í…Œê³ ë¦¬ë³„)
    const FILTER_CONDITIONS = [
      null,  // í•„í„° ì—†ìŒ
      { field: 'category', value: 'ì „ìì œí’ˆ' },
      { field: 'category', value: 'ìƒí™œìš©í’ˆ' },
      { field: 'category', value: 'ì˜ë¥˜' },
      { field: 'category', value: 'ì‹í’ˆ' },
      { field: 'region', value: 'ì„œìš¸' },
      { field: 'region', value: 'ë¶€ì‚°' },
      { field: 'region', value: 'ëŒ€êµ¬' },
      { field: 'region', value: 'ì¸ì²œ' },
      { field: 'region', value: 'ê´‘ì£¼' },
    ];

    // Arquero í”¼ë²—+ë¶€ë¶„í•© ë°˜ë³µ ë²¤ì¹˜ë§ˆí¬
    async function runArqueroPivotScenario() {
      log('=== Arquero í”¼ë²—+ë¶€ë¶„í•© ì‹œë‚˜ë¦¬ì˜¤ ===', 'info');
      const times = [];

      for (let i = 0; i < FILTER_CONDITIONS.length; i++) {
        const filter = FILTER_CONDITIONS[i];
        const filterDesc = filter ? `${filter.field}=${filter.value}` : 'ì „ì²´';

        arqueroWorker.postMessage({
          type: 'PIVOT_WITH_SUBTOTALS',
          id: `pivot_${i}`,
          filter
        });

        const result = await waitForMessage(arqueroWorker, 'QUERY_RESULT');
        times.push(result.queryTime);
        log(`[Arquero] í”¼ë²—+ë¶€ë¶„í•© (${filterDesc}): ${result.queryTime.toFixed(2)}ms`, 'time');
      }

      const total = times.reduce((a, b) => a + b, 0);
      const avg = total / times.length;
      log(`[Arquero] í”¼ë²—+ë¶€ë¶„í•© í‰ê· : ${avg.toFixed(2)}ms, ì´í•©: ${total.toFixed(2)}ms`, 'success');

      return { times, total, avg };
    }

    // DuckDB í”¼ë²—+ë¶€ë¶„í•© ë°˜ë³µ ë²¤ì¹˜ë§ˆí¬
    async function runDuckDBPivotScenario() {
      log('=== DuckDB í”¼ë²—+ë¶€ë¶„í•© ì‹œë‚˜ë¦¬ì˜¤ ===', 'info');
      const times = [];

      for (let i = 0; i < FILTER_CONDITIONS.length; i++) {
        const filter = FILTER_CONDITIONS[i];
        const filterDesc = filter ? `${filter.field}=${filter.value}` : 'ì „ì²´';

        duckdbWorker.postMessage({
          type: 'PIVOT_WITH_SUBTOTALS',
          id: `pivot_${i}`,
          filter
        });

        const result = await waitForMessage(duckdbWorker, 'QUERY_RESULT');
        times.push(result.queryTime);
        log(`[DuckDB] í”¼ë²—+ë¶€ë¶„í•© (${filterDesc}): ${result.queryTime.toFixed(2)}ms`, 'time');
      }

      const total = times.reduce((a, b) => a + b, 0);
      const avg = total / times.length;
      log(`[DuckDB] í”¼ë²—+ë¶€ë¶„í•© í‰ê· : ${avg.toFixed(2)}ms, ì´í•©: ${total.toFixed(2)}ms`, 'success');

      return { times, total, avg };
    }

    // í”¼ë²— ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼ í‘œì‹œ
    function displayPivotResults(arqueroRes, duckdbRes, arqueroLoad, duckdbLoad) {
      const pivotResultsDiv = document.getElementById('pivotResults');
      if (!pivotResultsDiv) return;

      pivotResultsDiv.style.display = 'block';

      const speedup = (arqueroRes.total / duckdbRes.total).toFixed(1);
      const winner = duckdbRes.total < arqueroRes.total ? 'DuckDB' : 'Arquero';

      // ì†ìµë¶„ê¸°ì  ê³„ì‚°
      const loadDiff = duckdbLoad - arqueroLoad;  // DuckDBê°€ ë¡œë“œì—ì„œ ëŠë¦° ì‹œê°„
      const queryGain = arqueroRes.avg - duckdbRes.avg;  // DuckDBê°€ ì¿¼ë¦¬ë‹¹ ë¹ ë¥¸ ì‹œê°„

      let breakeven = 'í•´ë‹¹ì—†ìŒ';
      if (queryGain > 0) {
        breakeven = Math.ceil(loadDiff / queryGain) + 'íšŒ';
      }

      pivotResultsDiv.innerHTML = `
        <h3>ğŸ”„ í”¼ë²—+ë¶€ë¶„í•©+í•„í„° ë°˜ë³µ ì‹œë‚˜ë¦¬ì˜¤ (${FILTER_CONDITIONS.length}íšŒ)</h3>
        <p>í”¼ë²— ëª¨ë“œì—ì„œ í•„í„°ë¥¼ ë³€ê²½í•  ë•Œë§ˆë‹¤ ë°œìƒí•˜ëŠ” ì¬ê³„ì‚° ì‹œë®¬ë ˆì´ì…˜</p>

        <table class="comparison-table">
          <thead>
            <tr>
              <th>í•­ëª©</th>
              <th>Arquero</th>
              <th>DuckDB</th>
              <th>ë¹„êµ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>í‰ê·  ì¿¼ë¦¬ ì‹œê°„</td>
              <td>${arqueroRes.avg.toFixed(2)}ms</td>
              <td>${duckdbRes.avg.toFixed(2)}ms</td>
              <td>${queryGain > 0 ? `ğŸ¦† DuckDB ${(arqueroRes.avg / duckdbRes.avg).toFixed(1)}ë°° ë¹ ë¦„` : `ğŸ“Š Arquero ${(duckdbRes.avg / arqueroRes.avg).toFixed(1)}ë°° ë¹ ë¦„`}</td>
            </tr>
            <tr>
              <td>${FILTER_CONDITIONS.length}íšŒ ì´í•©</td>
              <td>${arqueroRes.total.toFixed(2)}ms</td>
              <td>${duckdbRes.total.toFixed(2)}ms</td>
              <td>${winner === 'DuckDB' ? `ğŸ¦† DuckDB ${speedup}ë°° ë¹ ë¦„` : `ğŸ“Š Arquero ${(1/parseFloat(speedup)).toFixed(1)}ë°° ë¹ ë¦„`}</td>
            </tr>
            <tr>
              <td>ë¡œë“œ ì‹œê°„ ì°¨ì´</td>
              <td colspan="2">${loadDiff.toFixed(0)}ms (DuckDBê°€ ëŠë¦¼)</td>
              <td></td>
            </tr>
            <tr>
              <td><strong>ì†ìµë¶„ê¸°ì </strong></td>
              <td colspan="2"><strong>${breakeven}</strong></td>
              <td>${queryGain > 0 ? 'í•„í„° ë³€ê²½ íšŸìˆ˜' : 'DuckDBê°€ í•­ìƒ ëŠë¦¼'}</td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top: 15px; padding: 10px; background: ${queryGain > 0 ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
          <strong>ê²°ë¡ :</strong>
          ${queryGain > 0
            ? `í”¼ë²— ëª¨ë“œì—ì„œ í•„í„°ë¥¼ <strong>${breakeven}</strong> ì´ìƒ ë³€ê²½í•˜ë©´ DuckDBê°€ ìœ ë¦¬í•©ë‹ˆë‹¤.`
            : `í˜„ì¬ ë°ì´í„° ê·œëª¨ì—ì„œëŠ” Arqueroê°€ í•­ìƒ ìœ ë¦¬í•©ë‹ˆë‹¤.`
          }
        </div>
      `;
    }

    // ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰
    async function runBenchmark() {
      runBtn.disabled = true;
      logDiv.innerHTML = '';

      try {
        const rowCount = parseInt(rowCountSelect.value);
        const colCount = parseInt(colCountSelect.value);

        setStatus('Workers ì´ˆê¸°í™” ì¤‘...', 'loading');
        await initWorkers();

        setStatus('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì¤‘...', 'loading');
        const { data } = generateData(rowCount, colCount);

        setStatus('Arquero ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ ì¤‘...', 'loading');
        const arqueroRes = await runArqueroBenchmarks(data);

        setStatus('DuckDB ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ ì¤‘...', 'loading');
        const duckdbRes = await runDuckDBBenchmarks(data);

        displayResults(arqueroRes, duckdbRes);

        // í”¼ë²—+ë¶€ë¶„í•© ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
        setStatus('í”¼ë²—+ë¶€ë¶„í•© ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ì¤‘...', 'loading');
        const arqueroPivotRes = await runArqueroPivotScenario();
        const duckdbPivotRes = await runDuckDBPivotScenario();

        // ë¡œë“œ ì‹œê°„ (Arrow ë³€í™˜ í¬í•¨)
        const arqueroLoadTotal = arqueroRes.transfer;
        const duckdbLoadTotal = duckdbRes.arrowConvert + duckdbRes.transfer;

        displayPivotResults(arqueroPivotRes, duckdbPivotRes, arqueroLoadTotal, duckdbLoadTotal);

        const querySpeedup = (arqueroRes.totalQuery / duckdbRes.totalQuery).toFixed(1);

        let summary;
        if (duckdbRes.totalQuery < arqueroRes.totalQuery) {
          summary = `ìˆœìˆ˜ ì¿¼ë¦¬: DuckDB ${querySpeedup}ë°° ë¹ ë¦„`;
        } else {
          summary = `ìˆœìˆ˜ ì¿¼ë¦¬: Arquero ${(1/parseFloat(querySpeedup)).toFixed(1)}ë°° ë¹ ë¦„`;
        }

        setStatus(`ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ! ${summary}`, 'success');

        // Cleanup
        arqueroWorker.postMessage({ type: 'CLEANUP' });
        duckdbWorker.postMessage({ type: 'CLEANUP' });

      } catch (error) {
        log(`ì—ëŸ¬: ${error.message}`, 'error');
        setStatus(`ì—ëŸ¬ ë°œìƒ: ${error.message}`, 'error');
        console.error(error);
      } finally {
        runBtn.disabled = false;
      }
    }

    // ê²°ê³¼ ì´ˆê¸°í™”
    function clearResults() {
      resultsDiv.style.display = 'none';
      comparisonTable.style.display = 'none';
      arqueroResultsDiv.innerHTML = '';
      duckdbResultsDiv.innerHTML = '';
      comparisonBody.innerHTML = '';
      logDiv.innerHTML = '';
      setStatus('ì¤€ë¹„ë¨. ë²¤ì¹˜ë§ˆí¬ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');

      // Workers ì¢…ë£Œ
      if (arqueroWorker) {
        arqueroWorker.terminate();
        arqueroWorker = null;
      }
      if (duckdbWorker) {
        duckdbWorker.terminate();
        duckdbWorker = null;
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    runBtn.addEventListener('click', runBenchmark);
    clearBtn.addEventListener('click', clearResults);

    log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ë²¤ì¹˜ë§ˆí¬ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.', 'success');
  </script>
</body>
</html>
