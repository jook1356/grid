<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë´‡ ê·¸ë¦¬ë“œ (Pivot Grid) - PureSheet Demo</title>
  <link rel="stylesheet" href="../shared/styles.css">
  <link rel="stylesheet" href="../../src/ui/style/default.css">
  <style>
    /* í”¼ë´‡ ì„¤ì • íŒ¨ë„ */
    .pivot-config-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 16px;
      background: #f9f9f9;
      border-bottom: 1px solid var(--demo-border);
    }
    
    .config-section {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .config-section h4 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--demo-text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .field-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .field-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #e3f2fd;
      color: #1565c0;
      border-radius: 16px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .field-chip:hover {
      background: #bbdefb;
    }
    
    .field-chip.selected {
      background: #1976d2;
      color: white;
    }
    
    .field-chip .remove {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
    }
    
    /* í”¼ë´‡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° */
    .pivot-preview {
      padding: 12px 16px;
      background: #e8f5e9;
      border-bottom: 1px solid #c8e6c9;
      font-size: 13px;
      color: #2e7d32;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .pivot-preview.error {
      background: #ffebee;
      border-color: #ffcdd2;
      color: #c62828;
    }
    
    /* ë“œë¡­ë‹¤ìš´ í–¥ìƒ */
    .config-select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--demo-border);
      border-radius: 6px;
      font-size: 13px;
      background: white;
    }
    
    .config-select:focus {
      outline: none;
      border-color: var(--demo-primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }
    
    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    
    .checkbox-item input {
      width: 16px;
      height: 16px;
    }
    
    /* ê°’ í•„ë“œ ì„¤ì • */
    .value-field-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    
    .value-field-item select {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid var(--demo-border);
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="demo-nav">
    <a href="../index.html">ğŸ  í™ˆ</a>
    <a href="pinning.html">ğŸ“Œ í–‰/ì»¬ëŸ¼ ê³ ì •</a>
    <a href="multi-row.html">ğŸ“‘ Multi-Row</a>
    <a href="grouping.html">ğŸ“‚ í–‰ ê·¸ë£¹í™”</a>
    <a href="selection-modes.html">ğŸ¯ ì„ íƒ ëª¨ë“œ</a>
    <a href="pivot.html" class="active">ğŸ“Š í”¼ë´‡ ê·¸ë¦¬ë“œ</a>
  </nav>
  
  <!-- í—¤ë” -->
  <div class="demo-header">
    <h1>ğŸ“Š í”¼ë´‡ ê·¸ë¦¬ë“œ (Pivot Grid)</h1>
    <span class="badge badge-preview">ë¯¸ë¦¬ë³´ê¸°</span>
  </div>
  
  <!-- ì„¤ëª… -->
  <div class="demo-description">
    <p>
      <strong>í”¼ë´‡ ê·¸ë¦¬ë“œ</strong>ëŠ” ë°ì´í„°ë¥¼ í–‰ê³¼ ì—´ ê¸°ì¤€ìœ¼ë¡œ ì¬êµ¬ì„±í•˜ì—¬ ë‹¤ì°¨ì› ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.
      í–‰ í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ê³ , ì—´ í•„ë“œ ê°’ì„ ë™ì  ì»¬ëŸ¼ìœ¼ë¡œ í¼ì³ì„œ ê°’ í•„ë“œë¥¼ ì§‘ê³„í•©ë‹ˆë‹¤.
      Excelì˜ í”¼ë´‡ í…Œì´ë¸”ê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.
    </p>
  </div>
  
  <div class="demo-container">
    <!-- í”¼ë´‡ ì„¤ì • íŒ¨ë„ -->
    <div class="pivot-config-panel">
      <!-- í–‰ í•„ë“œ -->
      <div class="config-section">
        <h4>ğŸ“‹ í–‰ í•„ë“œ (Row Fields)</h4>
        <p style="font-size: 11px; color: #888; margin-bottom: 8px;">
          ê·¸ë£¹í™” ê¸°ì¤€ì´ ë˜ëŠ” í•„ë“œ
        </p>
        <div class="checkbox-group" id="rowFieldsContainer">
          <!-- JSì—ì„œ ìƒì„± -->
        </div>
      </div>
      
      <!-- ì—´ í•„ë“œ -->
      <div class="config-section">
        <h4>ğŸ“Š ì—´ í•„ë“œ (Column Fields)</h4>
        <p style="font-size: 11px; color: #888; margin-bottom: 8px;">
          ë™ì  ì»¬ëŸ¼ìœ¼ë¡œ í¼ì³ì§ˆ í•„ë“œ
        </p>
        <div class="checkbox-group" id="columnFieldsContainer">
          <!-- JSì—ì„œ ìƒì„± -->
        </div>
      </div>
      
      <!-- ê°’ í•„ë“œ -->
      <div class="config-section">
        <h4>ğŸ’° ê°’ í•„ë“œ (Value Fields)</h4>
        <p style="font-size: 11px; color: #888; margin-bottom: 8px;">
          ì§‘ê³„í•  ìˆ«ì í•„ë“œì™€ í•¨ìˆ˜
        </p>
        <div id="valueFieldsContainer">
          <!-- JSì—ì„œ ìƒì„± -->
        </div>
      </div>
    </div>
    
    <!-- íˆ´ë°” -->
    <div class="toolbar">
      <div class="toolbar-group">
        <button onclick="applyPivot()">ğŸ”„ í”¼ë´‡ ì ìš©</button>
        <button onclick="resetToNormal()" class="secondary">â†©ï¸ ì¼ë°˜ ëª¨ë“œ</button>
      </div>
      
      <div class="toolbar-divider"></div>
      
      <div class="toolbar-group">
        <label>ë°ì´í„° í¬ê¸°:</label>
        <select id="dataSizeSelect" onchange="regenerateData()">
          <option value="100">100í–‰</option>
          <option value="500" selected>500í–‰</option>
          <option value="1000">1,000í–‰</option>
          <option value="5000">5,000í–‰</option>
        </select>
      </div>
      
      <div class="toolbar-divider"></div>
      
      <div class="toolbar-group">
        <span id="modeIndicator" style="font-size: 13px; color: #666;">
          ğŸ“‹ ì¼ë°˜ ëª¨ë“œ
        </span>
      </div>
    </div>
    
    <!-- í”¼ë´‡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
    <div class="pivot-preview" id="pivotPreview" style="display: none;">
      <span>âœ…</span>
      <span id="pivotPreviewText"></span>
    </div>
    
    <!-- ê·¸ë¦¬ë“œ -->
    <div id="grid"></div>
    
    <!-- ìƒíƒœë°” -->
    <div class="status-bar" id="status">
      ì¤€ë¹„ë¨ - í”¼ë´‡ ì„¤ì •ì„ ì„ íƒí•˜ê³  "í”¼ë´‡ ì ìš©" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
    </div>
  </div>
  
  <!-- ì½”ë“œ ì˜ˆì œ -->
  <div class="code-example">
    <h3>API ì‚¬ìš©ë²•</h3>
    <pre><span class="comment">// WorkerBridgeë¥¼ í†µí•œ í”¼ë´‡ ì‹¤í–‰</span>
<span class="keyword">const</span> result = <span class="keyword">await</span> workerBridge.<span class="function">pivot</span>({
  <span class="property">rowFields</span>: [<span class="string">'department'</span>, <span class="string">'team'</span>],
  <span class="property">columnFields</span>: [<span class="string">'year'</span>, <span class="string">'quarter'</span>],
  <span class="property">valueFields</span>: [
    { <span class="property">field</span>: <span class="string">'sales'</span>, <span class="property">aggregate</span>: <span class="string">'sum'</span> },
    { <span class="property">field</span>: <span class="string">'count'</span>, <span class="property">aggregate</span>: <span class="string">'count'</span> }
  ],
  <span class="property">filters</span>: [] <span class="comment">// ì„ íƒì  í•„í„°</span>
});

<span class="comment">// ê²°ê³¼ êµ¬ì¡°</span>
result.rows      <span class="comment">// í”¼ë´‡ëœ Row[] (ìƒˆë¡œìš´ ë°ì´í„°)</span>
result.columns   <span class="comment">// ë™ì  ìƒì„±ëœ ColumnDef[]</span>
result.generatedValueColumnKeys  <span class="comment">// ['2023_Q1_sales', '2023_Q2_sales', ...]</span>

<span class="comment">// ViewDataManagerë¡œ í”¼ë´‡ ëª¨ë“œ ì„¤ì •</span>
viewDataManager.<span class="function">setPivotMode</span>(config, result);
viewDataManager.<span class="function">isPivotMode</span>();  <span class="comment">// true</span>
viewDataManager.<span class="function">getPivotedData</span>();  <span class="comment">// Row[]</span>
viewDataManager.<span class="function">getPivotedColumns</span>();  <span class="comment">// ColumnDef[]</span></pre>
  </div>
  
  <!-- í˜„ì¬ í”¼ë´‡ ì„¤ì • -->
  <div class="info-panel">
    <h3>ğŸ“Š í˜„ì¬ í”¼ë´‡ ì„¤ì •</h3>
    <pre id="pivotConfigDisplay">{
  "rowFields": [],
  "columnFields": [],
  "valueFields": []
}</pre>
  </div>
  
  <script type="module">
    // ëª¨ë“ˆ import
    const { GridCore, GridRenderer } = await import('../../src/index.ts');
    
    let gridCore = null;
    let renderer = null;
    let rawData = [];
    let pivotedData = null;
    let isPivotMode = false;
    
    // ì‚¬ìš© ê°€ëŠ¥í•œ í•„ë“œ ì •ì˜
    const availableFields = {
      categorical: [
        { key: 'department', label: 'ë¶€ì„œ' },
        { key: 'team', label: 'íŒ€' },
        { key: 'region', label: 'ì§€ì—­' },
        { key: 'year', label: 'ì—°ë„' },
        { key: 'quarter', label: 'ë¶„ê¸°' },
      ],
      numeric: [
        { key: 'sales', label: 'ë§¤ì¶œ' },
        { key: 'cost', label: 'ë¹„ìš©' },
        { key: 'profit', label: 'ì´ìµ' },
        { key: 'quantity', label: 'ìˆ˜ëŸ‰' },
      ],
    };
    
    const aggregateFunctions = [
      { value: 'sum', label: 'í•©ê³„' },
      { value: 'avg', label: 'í‰ê· ' },
      { value: 'min', label: 'ìµœì†Œ' },
      { value: 'max', label: 'ìµœëŒ€' },
      { value: 'count', label: 'ê°œìˆ˜' },
    ];
    
    // í˜„ì¬ í”¼ë´‡ ì„¤ì •
    let pivotConfig = {
      rowFields: ['department'],
      columnFields: ['year', 'quarter'],
      valueFields: [{ field: 'sales', aggregate: 'sum' }],
    };
    
    // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
    function generateSampleData(count) {
      const departments = ['Engineering', 'Marketing', 'Sales', 'HR', 'Finance'];
      const teams = ['AíŒ€', 'BíŒ€', 'CíŒ€'];
      const regions = ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ'];
      const years = ['2022', '2023', '2024'];
      const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
      
      return Array.from({ length: count }, (_, i) => ({
        id: i + 1,
        department: departments[i % departments.length],
        team: teams[i % teams.length],
        region: regions[i % regions.length],
        year: years[i % years.length],
        quarter: quarters[i % quarters.length],
        sales: Math.floor(Math.random() * 100000) + 10000,
        cost: Math.floor(Math.random() * 50000) + 5000,
        profit: Math.floor(Math.random() * 50000),
        quantity: Math.floor(Math.random() * 1000) + 100,
      }));
    }
    
    // UI ì´ˆê¸°í™”
    function initializeConfigUI() {
      // í–‰ í•„ë“œ ì²´í¬ë°•ìŠ¤
      const rowContainer = document.getElementById('rowFieldsContainer');
      rowContainer.innerHTML = availableFields.categorical.map(f => `
        <label class="checkbox-item">
          <input type="checkbox" value="${f.key}" 
            ${pivotConfig.rowFields.includes(f.key) ? 'checked' : ''}
            onchange="updateRowFields()">
          ${f.label}
        </label>
      `).join('');
      
      // ì—´ í•„ë“œ ì²´í¬ë°•ìŠ¤
      const colContainer = document.getElementById('columnFieldsContainer');
      colContainer.innerHTML = availableFields.categorical.map(f => `
        <label class="checkbox-item">
          <input type="checkbox" value="${f.key}"
            ${pivotConfig.columnFields.includes(f.key) ? 'checked' : ''}
            onchange="updateColumnFields()">
          ${f.label}
        </label>
      `).join('');
      
      // ê°’ í•„ë“œ ì„¤ì •
      updateValueFieldsUI();
    }
    
    function updateValueFieldsUI() {
      const container = document.getElementById('valueFieldsContainer');
      
      let html = pivotConfig.valueFields.map((vf, idx) => `
        <div class="value-field-item">
          <select onchange="updateValueField(${idx}, 'field', this.value)">
            ${availableFields.numeric.map(f => 
              `<option value="${f.key}" ${vf.field === f.key ? 'selected' : ''}>${f.label}</option>`
            ).join('')}
          </select>
          <select onchange="updateValueField(${idx}, 'aggregate', this.value)">
            ${aggregateFunctions.map(a => 
              `<option value="${a.value}" ${vf.aggregate === a.value ? 'selected' : ''}>${a.label}</option>`
            ).join('')}
          </select>
          <button onclick="removeValueField(${idx})" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ•</button>
        </div>
      `).join('');
      
      html += `
        <button onclick="addValueField()" style="width: 100%; padding: 8px; background: #e8f5e9; color: #2e7d32; border: 1px dashed #4caf50; border-radius: 6px; cursor: pointer; font-size: 13px;">
          + ê°’ í•„ë“œ ì¶”ê°€
        </button>
      `;
      
      container.innerHTML = html;
    }
    
    // í•„ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
    window.updateRowFields = function() {
      const checkboxes = document.querySelectorAll('#rowFieldsContainer input:checked');
      pivotConfig.rowFields = Array.from(checkboxes).map(cb => cb.value);
      updateConfigDisplay();
    };
    
    window.updateColumnFields = function() {
      const checkboxes = document.querySelectorAll('#columnFieldsContainer input:checked');
      pivotConfig.columnFields = Array.from(checkboxes).map(cb => cb.value);
      updateConfigDisplay();
    };
    
    window.updateValueField = function(idx, prop, value) {
      pivotConfig.valueFields[idx][prop] = value;
      updateConfigDisplay();
    };
    
    window.addValueField = function() {
      pivotConfig.valueFields.push({ field: 'sales', aggregate: 'sum' });
      updateValueFieldsUI();
      updateConfigDisplay();
    };
    
    window.removeValueField = function(idx) {
      if (pivotConfig.valueFields.length > 1) {
        pivotConfig.valueFields.splice(idx, 1);
        updateValueFieldsUI();
        updateConfigDisplay();
      }
    };
    
    function updateConfigDisplay() {
      document.getElementById('pivotConfigDisplay').textContent = 
        JSON.stringify(pivotConfig, null, 2);
    }
    
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }
    
    function updateModeIndicator(isPivot) {
      const indicator = document.getElementById('modeIndicator');
      if (isPivot) {
        indicator.innerHTML = 'ğŸ“Š <strong style="color: #1976d2;">í”¼ë´‡ ëª¨ë“œ</strong>';
      } else {
        indicator.innerHTML = 'ğŸ“‹ ì¼ë°˜ ëª¨ë“œ';
      }
    }
    
    // í”¼ë´‡ ì ìš©
    window.applyPivot = async function() {
      if (pivotConfig.columnFields.length === 0) {
        updateStatus('âŒ ì—´ í•„ë“œë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      
      updateStatus('â³ í”¼ë´‡ ê³„ì‚° ì¤‘...');
      
      try {
        const startTime = performance.now();
        
        // í”¼ë´‡ ì‹¤í–‰ (ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì§ì ‘ ê³„ì‚° - ë°ëª¨ìš©)
        const result = executePivot(rawData, pivotConfig);
        
        const duration = (performance.now() - startTime).toFixed(2);
        
        // ê²°ê³¼ í‘œì‹œ
        pivotedData = result;
        isPivotMode = true;
        
        // ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨
        await refreshGridWithPivot(result);
        
        // UI ì—…ë°ì´íŠ¸
        updateModeIndicator(true);
        showPivotPreview(result, duration);
        updateStatus(`âœ… í”¼ë´‡ ì™„ë£Œ - ${result.rows.length}í–‰, ${result.columns.length}ì»¬ëŸ¼ (${duration}ms)`);
        
      } catch (error) {
        console.error('Pivot error:', error);
        updateStatus(`âŒ í”¼ë´‡ ì‹¤íŒ¨: ${error.message}`);
        showPivotError(error.message);
      }
    };
    
    // í”¼ë´‡ ì‹¤í–‰ (ë°ëª¨ìš© - ì‹¤ì œë¡œëŠ” Workerì—ì„œ ì‹¤í–‰)
    function executePivot(data, config) {
      const { rowFields, columnFields, valueFields } = config;
      
      // ê·¸ë£¹í™” ë§µ
      const groupMap = new Map();
      
      // ë™ì  ì»¬ëŸ¼ ê°’ ìˆ˜ì§‘
      const columnValueSets = columnFields.map(() => new Set());
      
      for (const row of data) {
        // í–‰ í‚¤ ìƒì„±
        const rowKey = rowFields.map(f => String(row[f] ?? '')).join('\0');
        
        // ì»¬ëŸ¼ ê°’ ìˆ˜ì§‘
        const colValues = columnFields.map(f => String(row[f] ?? ''));
        colValues.forEach((v, i) => columnValueSets[i].add(v));
        const colKey = colValues.join('_');
        
        // ê·¸ë£¹ ë°ì´í„° ì´ˆê¸°í™”
        if (!groupMap.has(rowKey)) {
          const groupData = { __rowKey__: rowKey };
          rowFields.forEach((f, i) => {
            groupData[f] = rowKey.split('\0')[i];
          });
          groupMap.set(rowKey, { data: groupData, values: new Map() });
        }
        
        const group = groupMap.get(rowKey);
        
        // ê° ê°’ í•„ë“œì— ëŒ€í•´ ì§‘ê³„
        for (const vf of valueFields) {
          const fullKey = `${colKey}_${vf.field}`;
          const value = row[vf.field];
          
          if (!group.values.has(fullKey)) {
            group.values.set(fullKey, { sum: 0, count: 0, min: Infinity, max: -Infinity });
          }
          
          const agg = group.values.get(fullKey);
          if (typeof value === 'number') {
            agg.sum += value;
            agg.count += 1;
            agg.min = Math.min(agg.min, value);
            agg.max = Math.max(agg.max, value);
          }
        }
      }
      
      // ë™ì  ì»¬ëŸ¼ í‚¤ ìƒì„±
      const columnCombinations = cartesianProduct(
        columnValueSets.map(s => Array.from(s).sort())
      );
      
      const generatedValueColumnKeys = [];
      for (const combo of columnCombinations) {
        const colPrefix = combo.join('_');
        for (const vf of valueFields) {
          generatedValueColumnKeys.push(`${colPrefix}_${vf.field}`);
        }
      }
      
      // í”¼ë´‡ëœ í–‰ ìƒì„±
      const rows = [];
      for (const [rowKey, group] of groupMap) {
        const pivotedRow = { ...group.data };
        
        for (const colKey of generatedValueColumnKeys) {
          const agg = group.values.get(colKey);
          if (agg) {
            // aggregate í•¨ìˆ˜ì— ë”°ë¼ ê°’ ê³„ì‚°
            const parts = colKey.split('_');
            const fieldName = parts[parts.length - 1];
            const vf = valueFields.find(v => v.field === fieldName);
            
            switch (vf?.aggregate) {
              case 'sum':
                pivotedRow[colKey] = agg.sum;
                break;
              case 'avg':
                pivotedRow[colKey] = agg.count > 0 ? agg.sum / agg.count : 0;
                break;
              case 'min':
                pivotedRow[colKey] = agg.min === Infinity ? null : agg.min;
                break;
              case 'max':
                pivotedRow[colKey] = agg.max === -Infinity ? null : agg.max;
                break;
              case 'count':
                pivotedRow[colKey] = agg.count;
                break;
              default:
                pivotedRow[colKey] = agg.sum;
            }
          } else {
            pivotedRow[colKey] = null;
          }
        }
        
        rows.push(pivotedRow);
      }
      
      // ì»¬ëŸ¼ ì •ì˜ ìƒì„±
      const columns = [
        ...rowFields.map(f => ({
          key: f,
          header: availableFields.categorical.find(af => af.key === f)?.label || f,
          width: 120,
          type: 'string',
        })),
        ...generatedValueColumnKeys.map(key => ({
          key,
          header: formatColumnHeader(key),
          width: 100,
          type: 'number',
          formatter: (v) => v != null ? v.toLocaleString() : '-',
        })),
      ];
      
      return { rows, columns, generatedValueColumnKeys };
    }
    
    function cartesianProduct(arrays) {
      if (arrays.length === 0) return [[]];
      if (arrays.length === 1) return arrays[0].map(v => [v]);
      
      const [first, ...rest] = arrays;
      const restProduct = cartesianProduct(rest);
      return first.flatMap(v => restProduct.map(r => [v, ...r]));
    }
    
    function formatColumnHeader(key) {
      // "2023_Q1_sales" â†’ "2023 Q1 ë§¤ì¶œ"
      const parts = key.split('_');
      const fieldKey = parts[parts.length - 1];
      const fieldLabel = availableFields.numeric.find(f => f.key === fieldKey)?.label || fieldKey;
      
      const prefix = parts.slice(0, -1).join(' ');
      return `${prefix} ${fieldLabel}`;
    }
    
    async function refreshGridWithPivot(result) {
      const container = document.getElementById('grid');
      
      // ê¸°ì¡´ ë Œë”ëŸ¬ ì •ë¦¬
      if (renderer) {
        renderer.destroy();
      }
      
      // ìƒˆ GridCore ìƒì„± (í”¼ë´‡ëœ ì»¬ëŸ¼ìœ¼ë¡œ)
      gridCore = new GridCore({ columns: result.columns });
      await gridCore.initialize();
      
      // ìƒˆ ë Œë”ëŸ¬ ìƒì„±
      renderer = new GridRenderer(container, {
        gridCore,
        options: {
          columns: result.columns,
          rowHeight: 36,
          headerHeight: 40,
          resizableColumns: true,
          theme: 'light',
        },
      });
      
      // í”¼ë´‡ëœ ë°ì´í„° ë¡œë“œ
      await gridCore.loadData(result.rows);
      renderer.refresh();
    }
    
    function showPivotPreview(result, duration) {
      const preview = document.getElementById('pivotPreview');
      const text = document.getElementById('pivotPreviewText');
      
      preview.style.display = 'flex';
      preview.classList.remove('error');
      text.textContent = `í”¼ë´‡ ì™„ë£Œ: ${result.rows.length}í–‰ Ã— ${result.columns.length}ì»¬ëŸ¼ (${result.generatedValueColumnKeys.length}ê°œ ë™ì  ì»¬ëŸ¼ ìƒì„±, ${duration}ms)`;
    }
    
    function showPivotError(message) {
      const preview = document.getElementById('pivotPreview');
      const text = document.getElementById('pivotPreviewText');
      
      preview.style.display = 'flex';
      preview.classList.add('error');
      text.textContent = `ì˜¤ë¥˜: ${message}`;
    }
    
    // ì¼ë°˜ ëª¨ë“œë¡œ ë³µì›
    window.resetToNormal = async function() {
      isPivotMode = false;
      pivotedData = null;
      
      // ì›ë³¸ ì»¬ëŸ¼ìœ¼ë¡œ ë³µì›
      const normalColumns = [
        { key: 'id', header: 'ID', width: 60 },
        { key: 'department', header: 'ë¶€ì„œ', width: 100 },
        { key: 'team', header: 'íŒ€', width: 80 },
        { key: 'region', header: 'ì§€ì—­', width: 80 },
        { key: 'year', header: 'ì—°ë„', width: 80 },
        { key: 'quarter', header: 'ë¶„ê¸°', width: 80 },
        { key: 'sales', header: 'ë§¤ì¶œ', width: 100, formatter: (v) => v?.toLocaleString() },
        { key: 'cost', header: 'ë¹„ìš©', width: 100, formatter: (v) => v?.toLocaleString() },
        { key: 'profit', header: 'ì´ìµ', width: 100, formatter: (v) => v?.toLocaleString() },
        { key: 'quantity', header: 'ìˆ˜ëŸ‰', width: 80 },
      ];
      
      const container = document.getElementById('grid');
      
      if (renderer) {
        renderer.destroy();
      }
      
      gridCore = new GridCore({ columns: normalColumns });
      await gridCore.initialize();
      
      renderer = new GridRenderer(container, {
        gridCore,
        options: {
          columns: normalColumns,
          rowHeight: 36,
          headerHeight: 40,
          resizableColumns: true,
          theme: 'light',
        },
      });
      
      await gridCore.loadData(rawData);
      renderer.refresh();
      
      // UI ì—…ë°ì´íŠ¸
      updateModeIndicator(false);
      document.getElementById('pivotPreview').style.display = 'none';
      updateStatus(`ğŸ“‹ ì¼ë°˜ ëª¨ë“œ - ${rawData.length}í–‰ í‘œì‹œ`);
    };
    
    // ë°ì´í„° í¬ê¸° ë³€ê²½
    window.regenerateData = async function() {
      const size = parseInt(document.getElementById('dataSizeSelect').value);
      rawData = generateSampleData(size);
      
      if (isPivotMode) {
        // í”¼ë´‡ ëª¨ë“œë©´ ë‹¤ì‹œ í”¼ë´‡ ì ìš©
        await applyPivot();
      } else {
        // ì¼ë°˜ ëª¨ë“œë©´ ë°ì´í„°ë§Œ ìƒˆë¡œê³ ì¹¨
        await gridCore.loadData(rawData);
        renderer.refresh();
      }
      
      updateStatus(`ğŸ“Š ${size}ê°œ í–‰ ë°ì´í„° ìƒì„±ë¨`);
    };
    
    // ì´ˆê¸°í™”
    async function init() {
      const container = document.getElementById('grid');
      
      // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
      rawData = generateSampleData(500);
      
      // ê¸°ë³¸ ì»¬ëŸ¼
      const normalColumns = [
        { key: 'id', header: 'ID', width: 60 },
        { key: 'department', header: 'ë¶€ì„œ', width: 100 },
        { key: 'team', header: 'íŒ€', width: 80 },
        { key: 'region', header: 'ì§€ì—­', width: 80 },
        { key: 'year', header: 'ì—°ë„', width: 80 },
        { key: 'quarter', header: 'ë¶„ê¸°', width: 80 },
        { key: 'sales', header: 'ë§¤ì¶œ', width: 100, formatter: (v) => v?.toLocaleString() },
        { key: 'cost', header: 'ë¹„ìš©', width: 100, formatter: (v) => v?.toLocaleString() },
        { key: 'profit', header: 'ì´ìµ', width: 100, formatter: (v) => v?.toLocaleString() },
        { key: 'quantity', header: 'ìˆ˜ëŸ‰', width: 80 },
      ];
      
      gridCore = new GridCore({ columns: normalColumns });
      await gridCore.initialize();
      
      renderer = new GridRenderer(container, {
        gridCore,
        options: {
          columns: normalColumns,
          rowHeight: 36,
          headerHeight: 40,
          resizableColumns: true,
          theme: 'light',
        },
      });
      
      await gridCore.loadData(rawData);
      renderer.refresh();
      
      // UI ì´ˆê¸°í™”
      initializeConfigUI();
      updateConfigDisplay();
      updateStatus('500ê°œ í–‰ ë¡œë“œ ì™„ë£Œ - í”¼ë´‡ ì„¤ì •ì„ ì„ íƒí•˜ê³  "í”¼ë´‡ ì ìš©" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
    }
    
    init().catch(console.error);
  </script>
</body>
</html>
