<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë²— ê·¸ë¦¬ë“œ (Pivot Grid) - PureSheet Demo</title>
  <link rel="stylesheet" href="../shared/styles.css">
  <link rel="stylesheet" href="../../src/ui/style/default.css">
</head>

<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="demo-nav">
    <a href="../index.html">ğŸ  í™ˆ</a>
    <a href="pinning.html">ğŸ“Œ í–‰/ì»¬ëŸ¼ ê³ ì •</a>
    <a href="multi-row.html">ğŸ“‘ Multi-Row</a>
    <a href="grouping.html">ğŸ“‚ í–‰ ê·¸ë£¹í™”</a>
    <a href="merge.html">ğŸ”— ì…€ ë³‘í•©</a>
    <a href="selection-modes.html">ğŸ¯ ì„ íƒ ëª¨ë“œ</a>
    <a href="pivot.html" class="active">ğŸ“Š í”¼ë²—</a>
    <a href="format-row.html">ğŸ¨ formatRow</a>
    <a href="crud.html">âœï¸ CRUD</a>
    <a href="column-visibility.html">ğŸ‘ï¸ í•„ë“œ ì„ íƒ</a>
  </nav>

  <!-- í—¤ë” -->
  <div class="demo-header">
    <h1>ğŸ“Š í”¼ë²— ê·¸ë¦¬ë“œ (Pivot Grid)</h1>
    <span class="badge badge-implemented">êµ¬í˜„ë¨</span>
  </div>

  <!-- ì„¤ëª… -->
  <div class="demo-description">
    <p>
      <strong>í”¼ë²— ê·¸ë¦¬ë“œ</strong>ëŠ” ë°ì´í„°ë¥¼ í–‰ ì°¨ì›ê³¼ ì—´ ì°¨ì›ìœ¼ë¡œ êµì°¨ ì§‘ê³„í•˜ì—¬ ë³´ì—¬ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
      ì•„ë˜ ì˜ˆì œì—ì„œëŠ” ì œí’ˆë³„(í–‰)ë¡œ ì›”ë³„(ì—´) íŒë§¤ëŸ‰ê³¼ ìˆ˜ìµì„ ì§‘ê³„í•©ë‹ˆë‹¤.
      ë‹¤ì¤‘ ë ˆë²¨ ì»¬ëŸ¼ í—¤ë”ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
    </p>
  </div>

  <div class="demo-container">
    <div class="toolbar">
      <div class="toolbar-group">
        <label>ë°ì´í„° ìˆ˜:</label>
        <select id="dataCountSelect" onchange="regenerateData()">
          <option value="120">120ê±´</option>
          <option value="1000">1,000ê±´</option>
          <option value="10000">1ë§Œê±´</option>
          <option value="100000" selected>10ë§Œê±´</option>
          <option value="500000">50ë§Œê±´</option>
          <option value="1000000">100ë§Œê±´</option>
          <option value="2000000">200ë§Œê±´</option>
          <option value="5000000">500ë§Œê±´</option>
        </select>
      </div>

      <div class="toolbar-divider"></div>

      <div class="toolbar-group">
        <label>í–‰ ì¶•:</label>
        <select id="rowFieldSelect" onchange="updatePivot()">
          <option value="product" selected>ì œí’ˆ</option>
          <option value="region">ì§€ì—­</option>
          <option value="product,region">ì œí’ˆ â†’ ì§€ì—­</option>
          <option value="segment,product">ì„¸ê·¸ë¨¼íŠ¸ â†’ ì œí’ˆ</option>
          <option value="product,region,segment">ì œí’ˆ â†’ ì§€ì—­ â†’ ì„¸ê·¸ë¨¼íŠ¸</option>
        </select>
      </div>

      <div class="toolbar-divider"></div>

      <div class="toolbar-group">
        <label>ì—´ ì¶•:</label>
        <select id="columnFieldSelect" onchange="updatePivot()">
          <option value="month" selected>ì›”</option>
          <option value="quarter">ë¶„ê¸°</option>
          <option value="quarter,month">ë¶„ê¸° â†’ ì›”</option>
          <option value="segment,quarter">ì„¸ê·¸ë¨¼íŠ¸ â†’ ë¶„ê¸°</option>
          <option value="quarter,month,segment">ë¶„ê¸° â†’ ì›” â†’ ì„¸ê·¸ë¨¼íŠ¸</option>
        </select>
      </div>

      <div class="toolbar-divider"></div>

      <div class="toolbar-group">
        <label>ê°’:</label>
        <select id="valueFieldSelect" onchange="updatePivot()">
          <option value="sales" selected>íŒë§¤ëŸ‰</option>
          <option value="profit">ìˆ˜ìµ</option>
          <option value="satisfaction">ë§Œì¡±ë„ (í‰ê· )</option>
          <option value="sales,profit">íŒë§¤ëŸ‰ + ìˆ˜ìµ</option>
        </select>
      </div>

      <div class="toolbar-divider"></div>

      <div class="toolbar-group">
        <button onclick="resetPivot()">ğŸ”„ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- ë¶€ë¶„í•©/ì´í•©ê³„ íˆ´ë°” -->
    <div class="toolbar" style="border-top: none; padding-top: 0;">
      <div class="toolbar-group">
        <label>ğŸ“Š í–‰ í•©ê³„:</label>
        <label class="checkbox-label">
          <input type="checkbox" id="showRowSubTotals" onchange="toggleRowSubTotals()">
          ì†Œê³„
        </label>
        <select id="rowSubTotalFields" onchange="updatePivot()" multiple class="multi-select" disabled
          title="ì†Œê³„ ì²´í¬ ì‹œ í™œì„±í™”">
          <option value="product">ì œí’ˆ</option>
          <option value="region">ì§€ì—­</option>
        </select>
        <label class="checkbox-label">
          <input type="checkbox" id="showRowGrandTotals" onchange="updatePivot()">
          ì´í•©ê³„
        </label>
      </div>

      <div class="toolbar-divider"></div>

      <div class="toolbar-group">
        <label>ğŸ“ˆ ì—´ í•©ê³„:</label>
        <label class="checkbox-label">
          <input type="checkbox" id="showColumnSubTotals" onchange="toggleColumnSubTotals()">
          ì†Œê³„
        </label>
        <select id="columnSubTotalFields" onchange="updatePivot()" multiple class="multi-select" disabled
          title="ì†Œê³„ ì²´í¬ ì‹œ í™œì„±í™”">
          <option value="quarter">ë¶„ê¸°</option>
          <option value="month">ì›”</option>
        </select>
        <label class="checkbox-label">
          <input type="checkbox" id="showColumnGrandTotals" onchange="updatePivot()">
          ì´í•©ê³„
        </label>
      </div>
    </div>

    <!-- í•„í„°/ì •ë ¬ íˆ´ë°” -->
    <div class="toolbar" style="border-top: none; padding-top: 0;">
      <div class="toolbar-group">
        <label>ğŸ” í•„í„°:</label>
        <select id="filterColumnSelect">
          <option value="">í•„í„° ì—†ìŒ</option>
          <option value="product">ì œí’ˆ</option>
          <option value="region">ì§€ì—­</option>
          <option value="quarter">ë¶„ê¸°</option>
          <option value="segment">ì„¸ê·¸ë¨¼íŠ¸</option>
        </select>
        <select id="filterValueSelect" onchange="applyFilter()" disabled>
          <option value="">ê°’ ì„ íƒ</option>
        </select>
        <button onclick="clearFilter()" class="secondary" style="padding: 4px 8px;">âœ•</button>
      </div>

      <div class="toolbar-divider"></div>

      <div class="toolbar-group">
        <label>â†•ï¸ ì •ë ¬:</label>
        <select id="sortColumnSelect" onchange="applySort()">
          <option value="">ì •ë ¬ ì—†ìŒ</option>
          <option value="product">ì œí’ˆ</option>
          <option value="region">ì§€ì—­</option>
          <option value="month">ì›”</option>
          <option value="quarter">ë¶„ê¸°</option>
          <option value="segment">ì„¸ê·¸ë¨¼íŠ¸</option>
          <option value="sales">íŒë§¤ëŸ‰</option>
          <option value="profit">ìˆ˜ìµ</option>
          <option value="satisfaction">ë§Œì¡±ë„</option>
        </select>
        <select id="sortDirectionSelect" onchange="applySort()">
          <option value="asc">ì˜¤ë¦„ì°¨ìˆœ â†‘</option>
          <option value="desc">ë‚´ë¦¼ì°¨ìˆœ â†“</option>
        </select>
      </div>

      <div class="toolbar-divider"></div>

      <div class="toolbar-group" id="filterSortStatus" style="color: #666; font-size: 12px;">
        í•„í„°/ì •ë ¬ ì—†ìŒ
      </div>
    </div>

    <div id="grid" style="height: 500px;"></div>

    <div class="status-bar" id="status">
      ì´ˆê¸°í™” ì¤‘...
    </div>
  </div>

  <!-- ì½”ë“œ ì˜ˆì œ -->
  <div class="code-example">
    <h3>API ì‚¬ìš©ë²• (Pivot ëª¨ë“œ + í•„í„°/ì •ë ¬)</h3>
    <pre><span class="comment">// í”¼ë²— ëª¨ë“œë¡œ PureSheet ìƒì„±</span>
<span class="keyword">const</span> pivotGrid = <span class="keyword">new</span> <span class="function">PureSheet</span>(container, {
  mode: <span class="string">'pivot'</span>,
  data: salesData,
  fields: [...],
  rowFields: [<span class="string">'product'</span>],
  columnFields: [<span class="string">'month'</span>],
  valueFields: [<span class="string">'sales'</span>],
});

<span class="comment">// ==========================================</span>
<span class="comment">// í•„í„° ì ìš© (í”¼ë²— ì „ì— ë°ì´í„° í•„í„°ë§)</span>
<span class="comment">// ==========================================</span>
<span class="keyword">await</span> pivotGrid.<span class="function">filter</span>([
  { columnKey: <span class="string">'region'</span>, operator: <span class="string">'eq'</span>, value: <span class="string">'ì„œìš¸'</span> }
]);

<span class="comment">// ì—¬ëŸ¬ ì¡°ê±´ í•„í„°ë§ (AND)</span>
<span class="keyword">await</span> pivotGrid.<span class="function">filter</span>([
  { columnKey: <span class="string">'region'</span>, operator: <span class="string">'eq'</span>, value: <span class="string">'ì„œìš¸'</span> },
  { columnKey: <span class="string">'sales'</span>, operator: <span class="string">'gte'</span>, value: <span class="number">100</span> }
]);

<span class="comment">// ==========================================</span>
<span class="comment">// ì •ë ¬ ì ìš© (í”¼ë²— ê²°ê³¼ì˜ í–‰ ìˆœì„œì— ì˜í–¥)</span>
<span class="comment">// ==========================================</span>
<span class="keyword">await</span> pivotGrid.<span class="function">sort</span>([
  { columnKey: <span class="string">'sales'</span>, direction: <span class="string">'desc'</span> }
]);

<span class="comment">// ë‹¤ì¤‘ ì •ë ¬</span>
<span class="keyword">await</span> pivotGrid.<span class="function">sort</span>([
  { columnKey: <span class="string">'product'</span>, direction: <span class="string">'asc'</span> },
  { columnKey: <span class="string">'sales'</span>, direction: <span class="string">'desc'</span> }
]);

<span class="comment">// ==========================================</span>
<span class="comment">// ë°ì´í„° ì²˜ë¦¬ ìˆœì„œ: í•„í„° â†’ ì •ë ¬ â†’ í”¼ë²—</span>
<span class="comment">// ==========================================</span>
<span class="comment">// í•„í„°ì™€ ì •ë ¬ì€ í”¼ë²— ì—°ì‚° ì „ì— ì ìš©ë©ë‹ˆë‹¤.</span>
<span class="comment">// í•„í„°ë§ëœ ë°ì´í„°ë§Œ í”¼ë²— ê²°ê³¼ì— í¬í•¨ë©ë‹ˆë‹¤.</span></pre>
  </div>

  <!-- ë°ì´í„° ì •ë³´ -->
  <div class="info-panel">
    <h3>ğŸ“‹ ìƒ˜í”Œ ë°ì´í„° êµ¬ì¡°</h3>
    <div class="data-preview">
      <table>
        <thead>
          <tr>
            <th>month</th>
            <th>quarter</th>
            <th>segment</th>
            <th>product</th>
            <th>region</th>
            <th>sales</th>
            <th>profit</th>
            <th>satisfaction</th>
          </tr>
        </thead>
        <tbody id="dataPreview">
          <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { PureSheet } from '../../src/index.ts';

    let sheet = null;
    let sampleData = [];

    // ê¸°ë³¸ ë°ì´í„° ë°°ì—´
    const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
    const quarters = ['Q1', 'Q1', 'Q1', 'Q2', 'Q2', 'Q2', 'Q3', 'Q3', 'Q3', 'Q4', 'Q4', 'Q4'];
    const products = ['ë…¸íŠ¸ë¶', 'ìŠ¤ë§ˆíŠ¸í°', 'íƒœë¸”ë¦¿', 'ëª¨ë‹ˆí„°', 'í‚¤ë³´ë“œ', 'ë§ˆìš°ìŠ¤', 'í—¤ë“œí°', 'ìŠ¤í”¼ì»¤', 'ì›¹ìº ', 'í”„ë¦°í„°'];
    const regions = ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…'];
    const segments = ['ê¸°ì—…', 'ì†Œë¹„ì', 'í™ˆì˜¤í”¼ìŠ¤'];

    // ë°ì´í„° ìƒì„± í•¨ìˆ˜
    function generateData(targetCount) {
      const startTime = performance.now();
      updateStatus(`ë°ì´í„° ìƒì„± ì¤‘... (ëª©í‘œ: ${targetCount.toLocaleString()}ê±´)`);

      const data = [];
      let id = 1;

      // ê¸°ë³¸ ì¡°í•© ìˆ˜: products Ã— regions Ã— months Ã— segments
      const baseComboCount = products.length * regions.length * months.length * segments.length;

      // í•„ìš”í•œ ë°˜ë³µ ìˆ˜ ê³„ì‚°
      const iterations = Math.ceil(targetCount / baseComboCount);

      for (let iter = 0; iter < iterations && data.length < targetCount; iter++) {
        for (const product of products) {
          if (data.length >= targetCount) break;
          for (const region of regions) {
            if (data.length >= targetCount) break;
            for (const segment of segments) {
              if (data.length >= targetCount) break;
              for (let i = 0; i < months.length; i++) {
                if (data.length >= targetCount) break;

                const baseSales = Math.floor(Math.random() * 100) + 50;
                const baseProfit = Math.floor(baseSales * (Math.random() * 0.3 + 0.1));
                // ë§Œì¡±ë„: 1.0 ~ 5.0 (ì†Œìˆ˜ì  1ìë¦¬)
                const baseSatisfaction = parseFloat((Math.random() * 4 + 1).toFixed(1));

                data.push({
                  id: id++,
                  month: months[i],
                  quarter: quarters[i],
                  product,
                  region,
                  segment,
                  sales: baseSales,
                  profit: baseProfit,
                  satisfaction: baseSatisfaction,
                });
              }
            }
          }
        }
      }

      const duration = performance.now() - startTime;
      console.log(`ë°ì´í„° ìƒì„± ì™„ë£Œ: ${data.length.toLocaleString()}ê±´ (${duration.toFixed(0)}ms)`);

      return data;
    }

    // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    function showDataPreview() {
      const tbody = document.getElementById('dataPreview');
      tbody.innerHTML = sampleData.slice(0, 5).map(row => `
        <tr>
          <td>${row.month}</td>
          <td>${row.quarter}</td>
          <td>${row.segment}</td>
          <td>${row.product}</td>
          <td>${row.region}</td>
          <td>${row.sales}</td>
          <td>${row.profit}</td>
          <td>${row.satisfaction}</td>
        </tr>
      `).join('') + '<tr><td colspan="8">... (ì´ ' + sampleData.length.toLocaleString() + 'í–‰)</td></tr>';
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    // í”¼ë²— ì„¤ì • íŒŒì‹±
    function parsePivotConfig() {
      const rowFieldSelect = document.getElementById('rowFieldSelect');
      const columnFieldSelect = document.getElementById('columnFieldSelect');
      const valueFieldSelect = document.getElementById('valueFieldSelect');

      // ë¶€ë¶„í•©/ì´í•©ê³„ ì˜µì…˜
      const showRowSubTotals = document.getElementById('showRowSubTotals').checked;
      const showRowGrandTotals = document.getElementById('showRowGrandTotals').checked;
      const showColumnSubTotals = document.getElementById('showColumnSubTotals').checked;
      const showColumnGrandTotals = document.getElementById('showColumnGrandTotals').checked;

      // ì†Œê³„ í•„ë“œ ì„ íƒ (ì„ íƒëœ ì˜µì…˜ë“¤)
      const rowSubTotalFieldsSelect = document.getElementById('rowSubTotalFields');
      const rowSubTotalFields = Array.from(rowSubTotalFieldsSelect.selectedOptions).map(opt => opt.value);

      const columnSubTotalFieldsSelect = document.getElementById('columnSubTotalFields');
      const columnSubTotalFields = Array.from(columnSubTotalFieldsSelect.selectedOptions).map(opt => opt.value);

      return {
        rowFields: rowFieldSelect.value.split(','),
        columnFields: columnFieldSelect.value.split(','),
        valueFields: valueFieldSelect.value.split(',').map(field => {
          const isSatisfaction = field === 'satisfaction';
          return {
            field,
            aggregate: isSatisfaction ? 'avg' : 'sum',
            header: field === 'sales' ? 'íŒë§¤ëŸ‰' : (isSatisfaction ? 'ë§Œì¡±ë„' : 'ìˆ˜ìµ'),
            formatter: isSatisfaction ? (v) => Number(v ?? 0).toFixed(1) : undefined
          };
        }),
        showRowSubTotals,
        showRowGrandTotals,
        showColumnSubTotals,
        showColumnGrandTotals,
        rowSubTotalFields: showRowSubTotals ? rowSubTotalFields : undefined,
        columnSubTotalFields: showColumnSubTotals ? columnSubTotalFields : undefined,
      };
    }

    // í–‰ ì†Œê³„ í† ê¸€
    window.toggleRowSubTotals = function () {
      const checkbox = document.getElementById('showRowSubTotals');
      const select = document.getElementById('rowSubTotalFields');
      select.disabled = !checkbox.checked;
      updatePivot();
    };

    // ì—´ ì†Œê³„ í† ê¸€
    window.toggleColumnSubTotals = function () {
      const checkbox = document.getElementById('showColumnSubTotals');
      const select = document.getElementById('columnSubTotalFields');
      select.disabled = !checkbox.checked;
      updatePivot();
    };

    // í”¼ë²— ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
    async function initPivotGrid() {
      const container = document.getElementById('grid');

      // ì´ˆê¸° ë°ì´í„° ìƒì„±
      const dataCount = parseInt(document.getElementById('dataCountSelect').value);
      sampleData = generateData(dataCount);
      showDataPreview();

      const fields = [
        { key: 'month', header: 'ì›”', dataType: 'string' },
        { key: 'quarter', header: 'ë¶„ê¸°', dataType: 'string' },
        { key: 'segment', header: 'ì„¸ê·¸ë¨¼íŠ¸', dataType: 'string' },
        { key: 'product', header: 'ì œí’ˆ', dataType: 'string' },
        { key: 'region', header: 'ì§€ì—­', dataType: 'string' },
        { key: 'sales', header: 'íŒë§¤ëŸ‰', dataType: 'number', aggregate: 'sum' },
        { key: 'profit', header: 'ìˆ˜ìµ', dataType: 'number', aggregate: 'sum' },
        { key: 'satisfaction', header: 'ë§Œì¡±ë„', dataType: 'number', aggregate: 'avg' },
      ];

      const pivotConfig = parsePivotConfig();

      sheet = new PureSheet(container, {
        mode: 'pivot',
        fields,
        rowFields: pivotConfig.rowFields,
        columnFields: pivotConfig.columnFields,
        valueFields: pivotConfig.valueFields.map(v => v.field),
        rowStyle: 'height: 36px;',
        headerStyle: 'height: 40px;',
        theme: 'light',
      });

      // ë°ì´í„° ë¨¼ì € ë¡œë“œ (í”¼ë²— ì—°ì‚° ì „ì— ë°ì´í„°ê°€ í•„ìš”)
      await sheet.loadData(sampleData);

      // ë°ì´í„° ë¡œë“œ í›„ í”¼ë²— ì„¤ì • ì ìš©
      await sheet.setPivotConfig(pivotConfig);

      updateStatus(`í”¼ë²— ì™„ë£Œ - ${sampleData.length.toLocaleString()}ê°œ ì›ë³¸ ë°ì´í„° â†’ ${sheet.getVisibleRowCount()}ê°œ í”¼ë²— í–‰`);
    }

    // ë°ì´í„° ì¬ìƒì„±
    window.regenerateData = async function () {
      if (!sheet) return;

      const dataCount = parseInt(document.getElementById('dataCountSelect').value);

      // ëŒ€ìš©ëŸ‰ ë°ì´í„° ê²½ê³ 
      if (dataCount >= 1000000) {
        updateStatus(`âš ï¸ ${(dataCount / 1000000).toFixed(0)}ë°±ë§Œê±´ ë°ì´í„° ìƒì„± ì¤‘... ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);
        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì§§ì€ ì§€ì—°
        await new Promise(resolve => setTimeout(resolve, 50));
      }

      const startTime = performance.now();

      sampleData = generateData(dataCount);
      showDataPreview();

      const genTime = performance.now() - startTime;
      updateStatus(`ë°ì´í„° ìƒì„± ì™„ë£Œ (${genTime.toFixed(0)}ms) - í”¼ë²— ê³„ì‚° ì¤‘...`);

      // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì§§ì€ ì§€ì—°
      await new Promise(resolve => setTimeout(resolve, 50));

      const pivotStart = performance.now();
      await sheet.loadData(sampleData);

      const pivotConfig = parsePivotConfig();
      await sheet.setPivotConfig(pivotConfig);

      const pivotTime = performance.now() - pivotStart;
      const totalTime = performance.now() - startTime;

      updateStatus(`ì™„ë£Œ - ${sampleData.length.toLocaleString()}ê±´ â†’ ${sheet.getVisibleRowCount()}í–‰ (ìƒì„±: ${genTime.toFixed(0)}ms, í”¼ë²—: ${pivotTime.toFixed(0)}ms, ì´: ${totalTime.toFixed(0)}ms)`);
    };

    // ì†Œê³„ í•„ë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸
    function updateSubtotalFieldOptions() {
      // í–‰ ì†Œê³„ í•„ë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸
      const rowFields = document.getElementById('rowFieldSelect').value.split(',');
      const rowSubTotalSelect = document.getElementById('rowSubTotalFields');
      rowSubTotalSelect.innerHTML = rowFields.map(field => {
        const label = field === 'product' ? 'ì œí’ˆ' : field === 'region' ? 'ì§€ì—­' : field === 'segment' ? 'ì„¸ê·¸ë¨¼íŠ¸' : field;
        return `<option value="${field}">${label}</option>`;
      }).join('');

      // ì—´ ì†Œê³„ í•„ë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸
      const columnFields = document.getElementById('columnFieldSelect').value.split(',');
      const columnSubTotalSelect = document.getElementById('columnSubTotalFields');
      columnSubTotalSelect.innerHTML = columnFields.map(field => {
        const label = field === 'quarter' ? 'ë¶„ê¸°' : field === 'month' ? 'ì›”' : field === 'segment' ? 'ì„¸ê·¸ë¨¼íŠ¸' : field;
        return `<option value="${field}">${label}</option>`;
      }).join('');
    }

    // í”¼ë²— ì—…ë°ì´íŠ¸
    window.updatePivot = async function () {
      if (!sheet) return;

      // ì†Œê³„ í•„ë“œ ì˜µì…˜ ë™ê¸°í™”
      updateSubtotalFieldOptions();

      const pivotConfig = parsePivotConfig();
      updateStatus('í”¼ë²— ê³„ì‚° ì¤‘...');

      try {
        await sheet.setPivotConfig(pivotConfig);
        const subtotalInfo = [];
        if (pivotConfig.showRowSubTotals) subtotalInfo.push('í–‰ì†Œê³„');
        if (pivotConfig.showRowGrandTotals) subtotalInfo.push('í–‰ì´í•©');
        if (pivotConfig.showColumnSubTotals) subtotalInfo.push('ì—´ì†Œê³„');
        if (pivotConfig.showColumnGrandTotals) subtotalInfo.push('ì—´ì´í•©');
        const subtotalStr = subtotalInfo.length > 0 ? ` [${subtotalInfo.join(', ')}]` : '';
        updateStatus(`í”¼ë²— ì™„ë£Œ - í–‰: ${pivotConfig.rowFields.join(' â†’ ')}, ì—´: ${pivotConfig.columnFields.join(' â†’ ')}${subtotalStr}`);
      } catch (error) {
        console.error('Pivot error:', error);
        updateStatus('í”¼ë²— ì˜¤ë¥˜: ' + error.message);
      }
    };

    // ì´ˆê¸°í™”
    window.resetPivot = async function () {
      document.getElementById('rowFieldSelect').value = 'product';
      document.getElementById('columnFieldSelect').value = 'month';
      document.getElementById('valueFieldSelect').value = 'sales';
      document.getElementById('showRowSubTotals').checked = false;
      document.getElementById('showRowGrandTotals').checked = false;
      document.getElementById('showColumnSubTotals').checked = false;
      document.getElementById('showColumnGrandTotals').checked = false;
      document.getElementById('rowSubTotalFields').disabled = true;
      document.getElementById('columnSubTotalFields').disabled = true;
      await clearFilter();
      document.getElementById('sortColumnSelect').value = '';
      await applySort();
      await updatePivot();
    };

    // í˜„ì¬ í•„í„°/ì •ë ¬ ìƒíƒœ
    let currentFilter = null;
    let currentSort = null;

    // í•„í„°/ì •ë ¬ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateFilterSortStatus() {
      const parts = [];
      if (currentFilter) {
        parts.push(`í•„í„°: ${currentFilter.columnKey}="${currentFilter.value}"`);
      }
      if (currentSort) {
        parts.push(`ì •ë ¬: ${currentSort.columnKey} ${currentSort.direction === 'asc' ? 'â†‘' : 'â†“'}`);
      }
      document.getElementById('filterSortStatus').textContent =
        parts.length > 0 ? parts.join(' | ') : 'í•„í„°/ì •ë ¬ ì—†ìŒ';
    }

    // í•„í„° ì»¬ëŸ¼ ë³€ê²½ ì‹œ ê°’ ëª©ë¡ ì—…ë°ì´íŠ¸
    document.getElementById('filterColumnSelect').addEventListener('change', function () {
      const column = this.value;
      const valueSelect = document.getElementById('filterValueSelect');

      if (!column) {
        valueSelect.innerHTML = '<option value="">ê°’ ì„ íƒ</option>';
        valueSelect.disabled = true;
        clearFilter();
        return;
      }

      // í•´ë‹¹ ì»¬ëŸ¼ì˜ ìœ ë‹ˆí¬ ê°’ ì¶”ì¶œ
      const uniqueValues = [...new Set(sampleData.map(row => row[column]))].sort();

      valueSelect.innerHTML = '<option value="">ì „ì²´</option>' +
        uniqueValues.map(v => `<option value="${v}">${v}</option>`).join('');
      valueSelect.disabled = false;
    });

    // í•„í„° ì ìš©
    window.applyFilter = async function () {
      if (!sheet) return;

      const column = document.getElementById('filterColumnSelect').value;
      const value = document.getElementById('filterValueSelect').value;

      const startTime = performance.now();

      if (!column || !value) {
        currentFilter = null;
        await sheet.filter([]);
      } else {
        currentFilter = { columnKey: column, operator: 'eq', value };
        await sheet.filter([currentFilter]);
      }

      const duration = performance.now() - startTime;
      updateFilterSortStatus();
      updateStatus(`í•„í„° ì ìš© ì™„ë£Œ (${duration.toFixed(0)}ms) - ${sheet.getVisibleRowCount()}ê°œ í”¼ë²— í–‰`);
    };

    // í•„í„° í•´ì œ
    window.clearFilter = async function () {
      document.getElementById('filterColumnSelect').value = '';
      document.getElementById('filterValueSelect').innerHTML = '<option value="">ê°’ ì„ íƒ</option>';
      document.getElementById('filterValueSelect').disabled = true;

      if (sheet) {
        currentFilter = null;
        await sheet.filter([]);
        updateFilterSortStatus();
        updateStatus(`í•„í„° í•´ì œ - ${sheet.getVisibleRowCount()}ê°œ í”¼ë²— í–‰`);
      }
    };

    // ì •ë ¬ ì ìš©
    window.applySort = async function () {
      if (!sheet) return;

      const column = document.getElementById('sortColumnSelect').value;
      const direction = document.getElementById('sortDirectionSelect').value;

      const startTime = performance.now();

      if (!column) {
        currentSort = null;
        await sheet.sort([]);
      } else {
        currentSort = { columnKey: column, direction };
        await sheet.sort([currentSort]);
      }

      const duration = performance.now() - startTime;
      updateFilterSortStatus();
      updateStatus(`ì •ë ¬ ì ìš© ì™„ë£Œ (${duration.toFixed(0)}ms) - ${sheet.getVisibleRowCount()}ê°œ í”¼ë²— í–‰`);
    };

    // ì´ˆê¸°í™”
    initPivotGrid().catch(console.error);
  </script>

  <style>
    .info-panel {
      margin: 20px auto;
      max-width: 1200px;
      padding: 15px 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .info-panel h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #495057;
    }

    .data-preview {
      overflow-x: auto;
    }

    .data-preview table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .data-preview th,
    .data-preview td {
      padding: 6px 10px;
      border: 1px solid #dee2e6;
      text-align: left;
    }

    .data-preview th {
      background: #e9ecef;
      font-weight: 600;
    }

    .data-preview tr:nth-child(even) {
      background: #f8f9fa;
    }

    .data-preview tr:last-child td {
      text-align: center;
      color: #6c757d;
      font-style: italic;
    }

    /* ì²´í¬ë°•ìŠ¤ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 12px;
      cursor: pointer;
      font-size: 13px;
    }

    .checkbox-label input[type="checkbox"] {
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"]:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* ë©€í‹° ì…€ë ‰íŠ¸ ìŠ¤íƒ€ì¼ */
    .multi-select {
      min-width: 80px;
      max-width: 150px;
      height: 52px;
      padding: 2px;
      font-size: 11px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background: white;
    }

    .multi-select:disabled {
      background: #e9ecef;
      opacity: 0.6;
      cursor: not-allowed;
    }

    .multi-select option {
      padding: 2px 4px;
    }
  </style>
</body>

</html>