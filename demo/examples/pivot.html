<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë´‡ ê·¸ë¦¬ë“œ (Pivot Grid) - PureSheet Demo</title>
  <link rel="stylesheet" href="../shared/styles.css">
  <link rel="stylesheet" href="../../src/ui/style/default.css">
  <style>
    /* í”¼ë´‡ ì„¤ì • íŒ¨ë„ */
    .pivot-config-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 16px;
      background: #f9f9f9;
      border-bottom: 1px solid var(--demo-border);
    }
    
    .config-section {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .config-section h4 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--demo-text-secondary);
      margin-bottom: 8px;
    }
    
    .config-section .hint {
      font-size: 11px;
      color: #888;
      margin-bottom: 8px;
    }
    
    /* ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    
    .checkbox-item input {
      width: 16px;
      height: 16px;
    }
    
    /* ê°’ í•„ë“œ ì„¤ì • */
    .value-field-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    
    .value-field-item select {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid var(--demo-border);
      border-radius: 4px;
      font-size: 12px;
    }
    
    .value-field-item .remove-btn {
      padding: 4px 8px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .add-field-btn {
      width: 100%;
      padding: 8px;
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px dashed #4caf50;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    
    /* í”¼ë´‡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° */
    .pivot-preview {
      padding: 12px 16px;
      background: #e8f5e9;
      border-bottom: 1px solid #c8e6c9;
      font-size: 13px;
      color: #2e7d32;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .pivot-preview.visible {
      display: flex;
    }
    
    .pivot-preview.error {
      background: #ffebee;
      border-color: #ffcdd2;
      color: #c62828;
    }
    
    /* ëª¨ë“œ ì¸ë””ì¼€ì´í„° */
    .mode-indicator {
      font-size: 13px;
      color: #666;
    }
    
    .mode-indicator.pivot {
      color: #1976d2;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="demo-nav">
    <a href="../index.html">ğŸ  í™ˆ</a>
    <a href="pinning.html">ğŸ“Œ í–‰/ì»¬ëŸ¼ ê³ ì •</a>
    <a href="multi-row.html">ğŸ“‘ Multi-Row</a>
    <a href="grouping.html">ğŸ“‚ í–‰ ê·¸ë£¹í™”</a>
    <a href="selection-modes.html">ğŸ¯ ì„ íƒ ëª¨ë“œ</a>
    <a href="pivot.html" class="active">ğŸ“Š í”¼ë´‡ ê·¸ë¦¬ë“œ</a>
  </nav>
  
  <!-- í—¤ë” -->
  <div class="demo-header">
    <h1>ğŸ“Š í”¼ë´‡ ê·¸ë¦¬ë“œ (Pivot Grid)</h1>
    <span class="badge badge-preview">ë¯¸ë¦¬ë³´ê¸°</span>
  </div>
  
  <!-- ì„¤ëª… -->
  <div class="demo-description">
    <p>
      <strong>í”¼ë´‡ ê·¸ë¦¬ë“œ</strong>ëŠ” ë°ì´í„°ë¥¼ í–‰ê³¼ ì—´ ê¸°ì¤€ìœ¼ë¡œ ì¬êµ¬ì„±í•˜ì—¬ ë‹¤ì°¨ì› ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.
      í–‰ í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ê³ , ì—´ í•„ë“œ ê°’ì„ ë™ì  ì»¬ëŸ¼ìœ¼ë¡œ í¼ì³ì„œ ê°’ í•„ë“œë¥¼ ì§‘ê³„í•©ë‹ˆë‹¤.
      Excelì˜ í”¼ë´‡ í…Œì´ë¸”ê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.
    </p>
  </div>
  
  <div class="demo-container">
    <!-- í”¼ë´‡ ì„¤ì • íŒ¨ë„ -->
    <div class="pivot-config-panel">
      <!-- í–‰ í•„ë“œ -->
      <div class="config-section">
        <h4>ğŸ“‹ í–‰ í•„ë“œ (Row Fields)</h4>
        <p class="hint">ê·¸ë£¹í™” ê¸°ì¤€ì´ ë˜ëŠ” í•„ë“œ</p>
        <div class="checkbox-group" id="rowFieldsContainer"></div>
      </div>
      
      <!-- ì—´ í•„ë“œ -->
      <div class="config-section">
        <h4>ğŸ“Š ì—´ í•„ë“œ (Column Fields)</h4>
        <p class="hint">ë™ì  ì»¬ëŸ¼ìœ¼ë¡œ í¼ì³ì§ˆ í•„ë“œ</p>
        <div class="checkbox-group" id="columnFieldsContainer"></div>
      </div>
      
      <!-- ê°’ í•„ë“œ -->
      <div class="config-section">
        <h4>ğŸ’° ê°’ í•„ë“œ (Value Fields)</h4>
        <p class="hint">ì§‘ê³„í•  ìˆ«ì í•„ë“œì™€ í•¨ìˆ˜</p>
        <div id="valueFieldsContainer"></div>
      </div>
    </div>
    
    <!-- íˆ´ë°” -->
    <div class="toolbar">
      <div class="toolbar-group">
        <button id="applyPivotBtn">ğŸ”„ í”¼ë´‡ ì ìš©</button>
        <button id="resetBtn" class="secondary">â†©ï¸ ì¼ë°˜ ëª¨ë“œ</button>
      </div>
      
      <div class="toolbar-divider"></div>
      
      <div class="toolbar-group">
        <label>ë°ì´í„° í¬ê¸°:</label>
        <select id="dataSizeSelect">
          <option value="100">100í–‰</option>
          <option value="500" selected>500í–‰</option>
          <option value="1000">1,000í–‰</option>
          <option value="5000">5,000í–‰</option>
        </select>
      </div>
      
      <div class="toolbar-divider"></div>
      
      <div class="toolbar-group">
        <span id="modeIndicator" class="mode-indicator">ğŸ“‹ ì¼ë°˜ ëª¨ë“œ</span>
      </div>
    </div>
    
    <!-- í”¼ë´‡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
    <div class="pivot-preview" id="pivotPreview">
      <span>âœ…</span>
      <span id="pivotPreviewText"></span>
    </div>
    
    <!-- ê·¸ë¦¬ë“œ -->
    <div id="grid"></div>
    
    <!-- ìƒíƒœë°” -->
    <div class="status-bar" id="status">ì¤€ë¹„ë¨</div>
  </div>
  
  <!-- í˜„ì¬ í”¼ë´‡ ì„¤ì • -->
  <div class="info-panel">
    <h3>ğŸ“Š í˜„ì¬ í”¼ë´‡ ì„¤ì •</h3>
    <pre id="pivotConfigDisplay">{}</pre>
  </div>
  
  <!-- ì½”ë“œ ì˜ˆì œ -->
  <div class="code-example">
    <h3>API ì‚¬ìš©ë²•</h3>
    <pre><span class="comment">// PureSheet ì¸ìŠ¤í„´ìŠ¤ ìƒì„±</span>
<span class="keyword">const</span> sheet = <span class="keyword">new</span> <span class="function">PureSheet</span>(container, {
  <span class="property">columns</span>: columns,
});

<span class="comment">// ë°ì´í„° ë¡œë“œ</span>
<span class="keyword">await</span> sheet.<span class="function">loadData</span>(data);

<span class="comment">// í”¼ë´‡ ì„¤ì • ì ìš©</span>
<span class="keyword">const</span> result = <span class="keyword">await</span> sheet.<span class="function">setPivotConfig</span>({
  <span class="property">rowFields</span>: [<span class="string">'department'</span>],
  <span class="property">columnFields</span>: [<span class="string">'year'</span>],
  <span class="property">valueFields</span>: [
    { <span class="property">field</span>: <span class="string">'sales'</span>, <span class="property">aggregate</span>: <span class="string">'sum'</span> }
  ]
});

<span class="comment">// í”¼ë´‡ ëª¨ë“œ í™•ì¸</span>
sheet.<span class="function">isPivotMode</span>();  <span class="comment">// true</span>

<span class="comment">// ì¼ë°˜ ëª¨ë“œë¡œ ë³µê·€</span>
sheet.<span class="function">clearPivot</span>();
<span class="keyword">await</span> sheet.<span class="function">loadData</span>(originalData);</pre>
  </div>
  
  <script type="module">
    // PureSheet import
    const { PureSheet } = await import('../../src/index.ts');
    
    // ========================================
    // ìƒíƒœ ë³€ìˆ˜
    // ========================================
    let sheet = null;
    let rawData = [];
    
    // í”¼ë´‡ ì„¤ì •
    let pivotConfig = {
      rowFields: [],
      columnFields: [],
      valueFields: [{ field: 'sales', aggregate: 'sum' }],
    };
    
    // í•„ë“œ ì •ì˜
    const categoricalFields = [
      { key: 'department', label: 'ë¶€ì„œ' },
      { key: 'team', label: 'íŒ€' },
      { key: 'region', label: 'ì§€ì—­' },
      { key: 'year', label: 'ì—°ë„' },
      { key: 'quarter', label: 'ë¶„ê¸°' },
    ];
    
    const numericFields = [
      { key: 'sales', label: 'ë§¤ì¶œ' },
      { key: 'cost', label: 'ë¹„ìš©' },
      { key: 'profit', label: 'ì´ìµ' },
      { key: 'quantity', label: 'ìˆ˜ëŸ‰' },
    ];
    
    const aggregateFunctions = [
      { value: 'sum', label: 'í•©ê³„' },
      { value: 'avg', label: 'í‰ê· ' },
      { value: 'min', label: 'ìµœì†Œ' },
      { value: 'max', label: 'ìµœëŒ€' },
      { value: 'count', label: 'ê°œìˆ˜' },
    ];
    
    // ì»¬ëŸ¼ ì •ì˜
    const columns = [
      { key: 'id', label: 'ID', type: 'number', width: 60 },
      { key: 'department', label: 'ë¶€ì„œ', type: 'string', width: 100 },
      { key: 'team', label: 'íŒ€', type: 'string', width: 80 },
      { key: 'region', label: 'ì§€ì—­', type: 'string', width: 80 },
      { key: 'year', label: 'ì—°ë„', type: 'string', width: 80 },
      { key: 'quarter', label: 'ë¶„ê¸°', type: 'string', width: 80 },
      { key: 'sales', label: 'ë§¤ì¶œ', type: 'number', width: 100 },
      { key: 'cost', label: 'ë¹„ìš©', type: 'number', width: 100 },
      { key: 'profit', label: 'ì´ìµ', type: 'number', width: 100 },
      { key: 'quantity', label: 'ìˆ˜ëŸ‰', type: 'number', width: 80 },
    ];
    
    // ========================================
    // ë°ì´í„° ìƒì„±
    // ========================================
    function generateSampleData(count) {
      const departments = ['Engineering', 'Marketing', 'Sales', 'HR', 'Finance'];
      const teams = ['AíŒ€', 'BíŒ€', 'CíŒ€'];
      const regions = ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ'];
      const years = ['2022', '2023', '2024'];
      const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
      
      return Array.from({ length: count }, (_, i) => ({
        id: i + 1,
        department: departments[i % departments.length],
        team: teams[i % teams.length],
        region: regions[i % regions.length],
        year: years[i % years.length],
        quarter: quarters[i % quarters.length],
        sales: Math.floor(Math.random() * 100000) + 10000,
        cost: Math.floor(Math.random() * 50000) + 5000,
        profit: Math.floor(Math.random() * 50000),
        quantity: Math.floor(Math.random() * 1000) + 100,
      }));
    }
    
    // ========================================
    // UI í—¬í¼
    // ========================================
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }
    
    function updateModeIndicator(isPivot) {
      const indicator = document.getElementById('modeIndicator');
      if (isPivot) {
        indicator.textContent = 'ğŸ“Š í”¼ë´‡ ëª¨ë“œ';
        indicator.className = 'mode-indicator pivot';
      } else {
        indicator.textContent = 'ğŸ“‹ ì¼ë°˜ ëª¨ë“œ';
        indicator.className = 'mode-indicator';
      }
    }
    
    function updateConfigDisplay() {
      document.getElementById('pivotConfigDisplay').textContent = 
        JSON.stringify(pivotConfig, null, 2);
    }
    
    function showPivotPreview(result, duration) {
      const preview = document.getElementById('pivotPreview');
      const text = document.getElementById('pivotPreviewText');
      
      preview.classList.add('visible');
      preview.classList.remove('error');
      
      const dynamicColCount = result.columns.length - pivotConfig.rowFields.length;
      text.textContent = `í”¼ë´‡ ì™„ë£Œ: ${result.rows.length}í–‰ Ã— ${result.columns.length}ì»¬ëŸ¼ (ë™ì  ì»¬ëŸ¼ ${dynamicColCount}ê°œ, ${duration}ms)`;
    }
    
    function showPivotError(message) {
      const preview = document.getElementById('pivotPreview');
      const text = document.getElementById('pivotPreviewText');
      
      preview.classList.add('visible', 'error');
      text.textContent = `ì˜¤ë¥˜: ${message}`;
    }
    
    function hidePivotPreview() {
      document.getElementById('pivotPreview').classList.remove('visible');
    }
    
    // ========================================
    // UI ì´ˆê¸°í™”
    // ========================================
    function initializeConfigUI() {
      // í–‰ í•„ë“œ ì²´í¬ë°•ìŠ¤
      const rowContainer = document.getElementById('rowFieldsContainer');
      rowContainer.innerHTML = categoricalFields.map(f => `
        <label class="checkbox-item">
          <input type="checkbox" value="${f.key}" data-type="row">
          ${f.label}
        </label>
      `).join('');
      
      // ì—´ í•„ë“œ ì²´í¬ë°•ìŠ¤
      const colContainer = document.getElementById('columnFieldsContainer');
      colContainer.innerHTML = categoricalFields.map(f => `
        <label class="checkbox-item">
          <input type="checkbox" value="${f.key}" data-type="column">
          ${f.label}
        </label>
      `).join('');
      
      // ê°’ í•„ë“œ UI
      updateValueFieldsUI();
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      rowContainer.addEventListener('change', handleRowFieldChange);
      colContainer.addEventListener('change', handleColumnFieldChange);
    }
    
    function updateValueFieldsUI() {
      const container = document.getElementById('valueFieldsContainer');
      
      let html = pivotConfig.valueFields.map((vf, idx) => `
        <div class="value-field-item">
          <select data-idx="${idx}" data-prop="field">
            ${numericFields.map(f => 
              `<option value="${f.key}" ${vf.field === f.key ? 'selected' : ''}>${f.label}</option>`
            ).join('')}
          </select>
          <select data-idx="${idx}" data-prop="aggregate">
            ${aggregateFunctions.map(a => 
              `<option value="${a.value}" ${vf.aggregate === a.value ? 'selected' : ''}>${a.label}</option>`
            ).join('')}
          </select>
          <button class="remove-btn" data-idx="${idx}">âœ•</button>
        </div>
      `).join('');
      
      html += `<button class="add-field-btn" id="addValueFieldBtn">+ ê°’ í•„ë“œ ì¶”ê°€</button>`;
      
      container.innerHTML = html;
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      container.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', handleValueFieldChange);
      });
      
      container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', handleRemoveValueField);
      });
      
      document.getElementById('addValueFieldBtn').addEventListener('click', handleAddValueField);
    }
    
    // ========================================
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // ========================================
    function handleRowFieldChange(e) {
      const checkboxes = document.querySelectorAll('#rowFieldsContainer input:checked');
      pivotConfig.rowFields = Array.from(checkboxes).map(cb => cb.value);
      updateConfigDisplay();
    }
    
    function handleColumnFieldChange(e) {
      const checkboxes = document.querySelectorAll('#columnFieldsContainer input:checked');
      pivotConfig.columnFields = Array.from(checkboxes).map(cb => cb.value);
      updateConfigDisplay();
    }
    
    function handleValueFieldChange(e) {
      const idx = parseInt(e.target.dataset.idx);
      const prop = e.target.dataset.prop;
      pivotConfig.valueFields[idx][prop] = e.target.value;
      updateConfigDisplay();
    }
    
    function handleAddValueField() {
      pivotConfig.valueFields.push({ field: 'sales', aggregate: 'sum' });
      updateValueFieldsUI();
      updateConfigDisplay();
    }
    
    function handleRemoveValueField(e) {
      if (pivotConfig.valueFields.length > 1) {
        const idx = parseInt(e.target.dataset.idx);
        pivotConfig.valueFields.splice(idx, 1);
        updateValueFieldsUI();
        updateConfigDisplay();
      }
    }
    
    // ========================================
    // í”¼ë´‡ API
    // ========================================
    async function applyPivot() {
      if (pivotConfig.rowFields.length === 0) {
        updateStatus('âŒ í–‰ í•„ë“œë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      
      if (pivotConfig.columnFields.length === 0) {
        updateStatus('âŒ ì—´ í•„ë“œë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      
      updateStatus('â³ í”¼ë´‡ ê³„ì‚° ì¤‘...');
      
      try {
        const startTime = performance.now();
        
        // PureSheet API í˜¸ì¶œ
        const result = await sheet.setPivotConfig(pivotConfig);
        
        const duration = (performance.now() - startTime).toFixed(2);
        
        updateModeIndicator(true);
        showPivotPreview(result, duration);
        updateStatus(`âœ… í”¼ë´‡ ì™„ë£Œ - ${result.rows.length}í–‰, ${result.columns.length}ì»¬ëŸ¼ (${duration}ms)`);
        
      } catch (error) {
        console.error('Pivot error:', error);
        updateStatus(`âŒ í”¼ë´‡ ì‹¤íŒ¨: ${error.message}`);
        showPivotError(error.message);
      }
    }
    
    async function resetToNormal() {
      // í”¼ë´‡ í•´ì œ
      sheet.clearPivot();
      
      // ì›ë³¸ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
      await sheet.loadData(rawData);
      
      updateModeIndicator(false);
      hidePivotPreview();
      updateStatus(`ğŸ“‹ ì¼ë°˜ ëª¨ë“œ - ${rawData.length}í–‰ í‘œì‹œ`);
    }
    
    async function regenerateData() {
      const size = parseInt(document.getElementById('dataSizeSelect').value);
      rawData = generateSampleData(size);
      
      if (sheet.isPivotMode()) {
        await sheet.loadData(rawData);
        await applyPivot();
      } else {
        await sheet.loadData(rawData);
      }
      
      updateStatus(`ğŸ“Š ${size.toLocaleString()}ê°œ í–‰ ë°ì´í„° ìƒì„±ë¨`);
    }
    
    // ========================================
    // ì´ˆê¸°í™”
    // ========================================
    async function init() {
      const container = document.getElementById('grid');
      
      // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
      rawData = generateSampleData(500);
      
      // PureSheet ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      sheet = new PureSheet(container, {
        columns,
        rowHeight: 36,
        headerHeight: 40,
        resizableColumns: true,
        theme: 'light',
      });
      
      // ë°ì´í„° ë¡œë“œ
      await sheet.loadData(rawData);
      
      // UI ì´ˆê¸°í™”
      initializeConfigUI();
      updateConfigDisplay();
      
      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      document.getElementById('applyPivotBtn').addEventListener('click', applyPivot);
      document.getElementById('resetBtn').addEventListener('click', resetToNormal);
      document.getElementById('dataSizeSelect').addEventListener('change', regenerateData);
      
      updateStatus('500ê°œ í–‰ ë¡œë“œ ì™„ë£Œ - í”¼ë´‡ ì„¤ì •ì„ ì„ íƒí•˜ê³  "í”¼ë´‡ ì ìš©" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
    }
    
    init().catch(console.error);
  </script>
</body>
</html>
