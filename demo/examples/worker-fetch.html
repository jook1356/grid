<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="stylesheet" href="../shared/styles.css">
    <link rel="stylesheet" href="../../src/ui/style/default.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureSheet - Web Worker ëŒ€ìš©ëŸ‰ í”¼ë²— Demo</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        h1 {
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .toolbar {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 12px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-group label {
            font-size: 13px;
            font-weight: 500;
        }

        .toolbar-group select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: #ddd;
        }

        #grid-container {
            height: 600px;
            border: 1px solid #ddd;
        }

        .status-bar {
            padding: 8px 16px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-top: none;
            font-size: 13px;
            color: #666;
        }

        .checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        button {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 13px;
        }

        button:hover {
            background: #f0f0f0;
        }

        .info-panel {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .info-panel h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .info-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .info-item .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .info-item .value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
    </style>
    <script src="../shared/nav-sidebar.js" defer></script>
</head>

<body>
    <!-- ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav-sidebar></nav-sidebar>

    <h1>ğŸš€ Web Worker ëŒ€ìš©ëŸ‰ í”¼ë²— (5ë°±ë§Œ ê±´)</h1>
    <p class="description">
        Web Workerë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹ ì—†ì´ ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ í”¼ë²— ì²˜ë¦¬í•©ë‹ˆë‹¤.
        5ë°±ë§Œ ê±´ì˜ íŒë§¤ ë°ì´í„°ë¥¼ ì œí’ˆ/ì§€ì—­/ì›”ë³„ë¡œ ì§‘ê³„í•©ë‹ˆë‹¤.
    </p>

    <div class="toolbar">
        <div class="toolbar-group">
            <label>ğŸ“Š ë°ì´í„° ìˆ˜:</label>
            <select id="dataCountSelect">
                <option value="100000">10ë§Œê±´</option>
                <option value="500000">50ë§Œê±´</option>
                <option value="1000000">100ë§Œê±´</option>
                <option value="2000000">200ë§Œê±´</option>
                <option value="5000000" selected>500ë§Œê±´</option>
            </select>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <label>í–‰ ì¶•:</label>
            <select id="rowFieldSelect">
                <option value="product" selected>ì œí’ˆ</option>
                <option value="region">ì§€ì—­</option>
                <option value="product,region">ì œí’ˆ â†’ ì§€ì—­</option>
            </select>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <label>ì—´ ì¶•:</label>
            <select id="columnFieldSelect">
                <option value="month" selected>ì›”</option>
                <option value="quarter">ë¶„ê¸°</option>
                <option value="quarter,month">ë¶„ê¸° â†’ ì›”</option>
            </select>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <label>ê°’:</label>
            <select id="valueFieldSelect">
                <option value="sales" selected>íŒë§¤ëŸ‰</option>
                <option value="profit">ìˆ˜ìµ</option>
                <option value="sales,profit">íŒë§¤ëŸ‰ + ìˆ˜ìµ</option>
            </select>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <label>ğŸ”§ ì—”ì§„:</label>
            <select id="engineSelect">
                <option value="aq" selected>Arquero</option>
                <option value="db">DuckDB-Wasm</option>
            </select>
            <label class="checkbox-label">
                <input type="checkbox" id="useWorkerCheckbox" checked>
                Web Worker
            </label>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <button onclick="regenerateData()">ğŸ”„ ë°ì´í„° ì¬ìƒì„±</button>
        </div>
    </div>

    <!-- í•„í„°/ì •ë ¬ íˆ´ë°” -->
    <div class="toolbar" style="border-top: none; background: #f0f4f8;">
        <div class="toolbar-group">
            <label>ğŸ” í•„í„°:</label>
            <select id="filterColumn">
                <option value="">ì—†ìŒ</option>
                <option value="product">ì œí’ˆ</option>
                <option value="region">ì§€ì—­</option>
                <option value="month">ì›”</option>
                <option value="quarter">ë¶„ê¸°</option>
            </select>
            <select id="filterOperator">
                <option value="eq">= ê°™ìŒ</option>
                <option value="contains">í¬í•¨</option>
                <option value="neq">â‰  ë‹¤ë¦„</option>
            </select>
            <input type="text" id="filterValue" placeholder="ê°’ ì…ë ¥"
                style="width: 100px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
            <button onclick="applyFilter()">ì ìš©</button>
            <button onclick="clearFilter()">ì´ˆê¸°í™”</button>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <label>â†•ï¸ ì •ë ¬:</label>
            <select id="sortColumn">
                <option value="">ì—†ìŒ</option>
                <option value="product">ì œí’ˆ</option>
                <option value="region">ì§€ì—­</option>
                <option value="sales">íŒë§¤ëŸ‰</option>
                <option value="profit">ìˆ˜ìµ</option>
                <option value="month">ì›”</option>
            </select>
            <select id="sortDirection">
                <option value="asc">ì˜¤ë¦„ì°¨ìˆœ â†‘</option>
                <option value="desc">ë‚´ë¦¼ì°¨ìˆœ â†“</option>
            </select>
            <button onclick="applySort()">ì ìš©</button>
            <button onclick="clearSort()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div id="grid-container"></div>
    <div class="status-bar" id="status">ì´ˆê¸°í™” ì¤‘...</div>

    <!-- ì„±ëŠ¥ ì •ë³´ íŒ¨ë„ -->
    <div class="info-panel">
        <h3>ğŸ“ˆ ì„±ëŠ¥ ì¸¡ì •</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="label">ë°ì´í„° ìƒì„±</div>
                <div class="value" id="genTime">-</div>
            </div>
            <div class="info-item">
                <div class="label">í”¼ë²— ì²˜ë¦¬</div>
                <div class="value" id="pivotTime">-</div>
            </div>
            <div class="info-item">
                <div class="label">ì´ ì†Œìš” ì‹œê°„</div>
                <div class="value" id="totalTime">-</div>
            </div>
            <div class="info-item">
                <div class="label">ì›ë³¸ ë°ì´í„°</div>
                <div class="value" id="sourceRows">-</div>
            </div>
            <div class="info-item">
                <div class="label">í”¼ë²— ê²°ê³¼ í–‰</div>
                <div class="value" id="pivotRows">-</div>
            </div>
            <div class="info-item">
                <div class="label">ì—”ì§„/ëª¨ë“œ</div>
                <div class="value" id="engineMode">-</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { PureSheet } from '../../src/index.ts';

        let sheet = null;
        let sampleData = [];

        // ë°ì´í„° ìƒì„±ìš© ë°°ì—´
        const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        const quarters = ['Q1', 'Q1', 'Q1', 'Q2', 'Q2', 'Q2', 'Q3', 'Q3', 'Q3', 'Q4', 'Q4', 'Q4'];
        const products = ['ë…¸íŠ¸ë¶', 'ìŠ¤ë§ˆíŠ¸í°', 'íƒœë¸”ë¦¿', 'ëª¨ë‹ˆí„°', 'í‚¤ë³´ë“œ', 'ë§ˆìš°ìŠ¤', 'í—¤ë“œí°', 'ìŠ¤í”¼ì»¤', 'ì›¹ìº ', 'í”„ë¦°í„°'];
        const regions = ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ê²½ê¸°', 'ê°•ì›'];

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // ì„±ëŠ¥ ì •ë³´ ì—…ë°ì´íŠ¸
        function updatePerformance(info) {
            if (info.genTime !== undefined) {
                document.getElementById('genTime').textContent = `${info.genTime.toLocaleString()}ms`;
            }
            if (info.pivotTime !== undefined) {
                document.getElementById('pivotTime').textContent = `${info.pivotTime.toLocaleString()}ms`;
            }
            if (info.totalTime !== undefined) {
                document.getElementById('totalTime').textContent = `${info.totalTime.toLocaleString()}ms`;
            }
            if (info.sourceRows !== undefined) {
                document.getElementById('sourceRows').textContent = `${info.sourceRows.toLocaleString()}ê±´`;
            }
            if (info.pivotRows !== undefined) {
                document.getElementById('pivotRows').textContent = `${info.pivotRows.toLocaleString()}í–‰`;
            }
            if (info.engineMode !== undefined) {
                document.getElementById('engineMode').textContent = info.engineMode;
            }
        }

        // ëŒ€ìš©ëŸ‰ ë°ì´í„° ìƒì„±
        function generateData(targetCount) {
            const startTime = performance.now();
            updateStatus(`â³ ${targetCount.toLocaleString()}ê±´ ë°ì´í„° ìƒì„± ì¤‘...`);

            const data = [];
            let id = 1;

            // ê¸°ë³¸ ì¡°í•© ìˆ˜: products Ã— regions Ã— months = 10 Ã— 10 Ã— 12 = 1200
            const baseComboCount = products.length * regions.length * months.length;
            const iterations = Math.ceil(targetCount / baseComboCount);

            for (let iter = 0; iter < iterations && data.length < targetCount; iter++) {
                for (const product of products) {
                    if (data.length >= targetCount) break;
                    for (const region of regions) {
                        if (data.length >= targetCount) break;
                        for (let i = 0; i < months.length; i++) {
                            if (data.length >= targetCount) break;

                            const baseSales = Math.floor(Math.random() * 100) + 50;
                            const baseProfit = Math.floor(baseSales * (Math.random() * 0.3 + 0.1));

                            data.push({
                                id: id++,
                                month: months[i],
                                quarter: quarters[i],
                                product,
                                region,
                                sales: baseSales,
                                profit: baseProfit,
                            });
                        }
                    }
                }
            }

            const duration = performance.now() - startTime;
            console.log(`ë°ì´í„° ìƒì„± ì™„ë£Œ: ${data.length.toLocaleString()}ê±´ (${duration.toFixed(0)}ms)`);

            return { data, duration };
        }

        // í”¼ë²— ì„¤ì • íŒŒì‹±
        function parsePivotConfig() {
            const rowFieldSelect = document.getElementById('rowFieldSelect');
            const columnFieldSelect = document.getElementById('columnFieldSelect');
            const valueFieldSelect = document.getElementById('valueFieldSelect');

            // rowFieldsë¥¼ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
            const rowFieldsArr = rowFieldSelect.value.split(',').map(field => {
                const headerMap = { product: 'ì œí’ˆ', region: 'ì§€ì—­' };
                return { field, header: headerMap[field] || field };
            });

            // columnFieldsë¥¼ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
            const columnFieldsArr = columnFieldSelect.value.split(',').map(field => {
                const headerMap = { month: 'ì›”', quarter: 'ë¶„ê¸°' };
                return { field, header: headerMap[field] || field };
            });

            // valueFieldsë¥¼ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
            const valueFieldsArr = valueFieldSelect.value.split(',').map(field => ({
                field,
                aggregate: 'sum',
                header: field === 'sales' ? 'íŒë§¤ëŸ‰' : 'ìˆ˜ìµ',
            }));

            return {
                rowFields: rowFieldsArr,
                columnFields: columnFieldsArr,
                valueFields: valueFieldsArr,
            };
        }

        // ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
        async function initGrid() {
            const container = document.getElementById('grid-container');
            const totalStart = performance.now();

            // ë°ì´í„° ìƒì„±
            const dataCount = parseInt(document.getElementById('dataCountSelect').value);
            const { data, duration: genTime } = generateData(dataCount);
            sampleData = data;

            updatePerformance({ genTime: Math.round(genTime), sourceRows: sampleData.length });

            // ì—”ì§„ ì˜µì…˜
            const engine = document.getElementById('engineSelect').value;
            const useWorker = document.getElementById('useWorkerCheckbox').checked;
            const engineLabel = engine === 'aq' ? 'Arquero' : 'DuckDB';
            const workerLabel = useWorker ? ' + Worker' : '';

            updatePerformance({ engineMode: `${engineLabel}${workerLabel}` });
            updateStatus(`â³ ${engineLabel}${workerLabel} ì—”ì§„ ì´ˆê¸°í™” ì¤‘...`);

            const pivotConfig = parsePivotConfig();

            try {
                // ê¸°ì¡´ ê·¸ë¦¬ë“œ ì œê±°
                if (sheet) {
                    sheet.destroy();
                    sheet = null;
                }

                const pivotStart = performance.now();

                sheet = new PureSheet(container, {
                    mode: 'pivot',
                    rowFields: pivotConfig.rowFields,
                    columnFields: pivotConfig.columnFields,
                    valueFields: pivotConfig.valueFields,
                    engine,
                    useWorker,
                    theme: 'light',
                });

                // ë°ì´í„° ë¡œë“œ ë° í”¼ë²— ì ìš©
                await sheet.loadData(sampleData);
                await sheet.setPivotConfig(pivotConfig);

                const pivotTime = performance.now() - pivotStart;
                const totalTime = performance.now() - totalStart;

                updatePerformance({
                    pivotTime: Math.round(pivotTime),
                    totalTime: Math.round(totalTime),
                    pivotRows: sheet.getVisibleRowCount(),
                });

                updateStatus(`âœ… ì™„ë£Œ [${engineLabel}${workerLabel}] - ${sampleData.length.toLocaleString()}ê±´ â†’ ${sheet.getVisibleRowCount()}í–‰ í”¼ë²— ê²°ê³¼`);

            } catch (error) {
                console.error('Grid initialization error:', error);
                updateStatus(`âŒ ì˜¤ë¥˜ [${engineLabel}${workerLabel}]: ${error.message}`);

                // DuckDB ì‹¤íŒ¨ ì‹œ Arqueroë¡œ í´ë°±
                if (engine === 'db') {
                    document.getElementById('engineSelect').value = 'aq';
                    updateStatus(`âŒ DuckDB ì´ˆê¸°í™” ì‹¤íŒ¨. Arqueroë¡œ ì¬ì‹œë„...`);
                    await new Promise(r => setTimeout(r, 100));
                    await initGrid();
                }
            }
        }

        // ë°ì´í„° ì¬ìƒì„±
        window.regenerateData = async function() {
            await initGrid();
        };

        // ì…€ë ‰íŠ¸ ë³€ê²½ ì‹œ í”¼ë²— ì—…ë°ì´íŠ¸
        document.getElementById('rowFieldSelect').addEventListener('change', async () => {
            if (!sheet) return;
            const pivotConfig = parsePivotConfig();
            updateStatus('â³ í”¼ë²— ì¬ê³„ì‚° ì¤‘...');
            const start = performance.now();
            await sheet.setPivotConfig(pivotConfig);
            const duration = performance.now() - start;
            updatePerformance({ pivotTime: Math.round(duration), pivotRows: sheet.getVisibleRowCount() });
            updateStatus(`âœ… í”¼ë²— ì™„ë£Œ (${Math.round(duration)}ms)`);
        });

        document.getElementById('columnFieldSelect').addEventListener('change', async () => {
            if (!sheet) return;
            const pivotConfig = parsePivotConfig();
            updateStatus('â³ í”¼ë²— ì¬ê³„ì‚° ì¤‘...');
            const start = performance.now();
            await sheet.setPivotConfig(pivotConfig);
            const duration = performance.now() - start;
            updatePerformance({ pivotTime: Math.round(duration), pivotRows: sheet.getVisibleRowCount() });
            updateStatus(`âœ… í”¼ë²— ì™„ë£Œ (${Math.round(duration)}ms)`);
        });

        document.getElementById('valueFieldSelect').addEventListener('change', async () => {
            if (!sheet) return;
            const pivotConfig = parsePivotConfig();
            updateStatus('â³ í”¼ë²— ì¬ê³„ì‚° ì¤‘...');
            const start = performance.now();
            await sheet.setPivotConfig(pivotConfig);
            const duration = performance.now() - start;
            updatePerformance({ pivotTime: Math.round(duration), pivotRows: sheet.getVisibleRowCount() });
            updateStatus(`âœ… í”¼ë²— ì™„ë£Œ (${Math.round(duration)}ms)`);
        });

        // ì—”ì§„/Worker ë³€ê²½ ì‹œ ê·¸ë¦¬ë“œ ì¬ìƒì„±
        document.getElementById('engineSelect').addEventListener('change', initGrid);
        document.getElementById('useWorkerCheckbox').addEventListener('change', initGrid);
        document.getElementById('dataCountSelect').addEventListener('change', initGrid);

        // í•„í„° ì ìš© (í”¼ë²— ëª¨ë“œì—ì„œëŠ” filter() ë‚´ë¶€ì—ì„œ ìë™ìœ¼ë¡œ í”¼ë²— ì¬ì ìš©)
        window.applyFilter = async function () {
            if (!sheet) return;
            const col = document.getElementById('filterColumn').value;
            if (!col) return;
            const op = document.getElementById('filterOperator').value;
            const val = document.getElementById('filterValue').value;
            if (!val) return;

            updateStatus('â³ í•„í„° ì ìš© ì¤‘...');
            const start = performance.now();
            await sheet.filter([{ columnKey: col, operator: op, value: val }]);
            const duration = performance.now() - start;
            updatePerformance({ pivotTime: Math.round(duration), pivotRows: sheet.getVisibleRowCount() });
            updateStatus(`âœ… í•„í„° ì™„ë£Œ (${Math.round(duration)}ms) - ${sheet.getVisibleRowCount().toLocaleString()}í–‰`);
        };

        window.clearFilter = async function () {
            if (!sheet) return;
            updateStatus('â³ í•„í„° ì´ˆê¸°í™” ì¤‘...');
            const start = performance.now();
            await sheet.filter([]);
            const duration = performance.now() - start;
            updatePerformance({ pivotTime: Math.round(duration), pivotRows: sheet.getVisibleRowCount() });
            updateStatus(`âœ… í•„í„° ì´ˆê¸°í™” (${Math.round(duration)}ms)`);
            document.getElementById('filterValue').value = '';
        };

        // ì •ë ¬ ì ìš© (í”¼ë²— ëª¨ë“œì—ì„œëŠ” sort() ë‚´ë¶€ì—ì„œ ìë™ìœ¼ë¡œ í”¼ë²— ì¬ì ìš©)
        window.applySort = async function () {
            if (!sheet) return;
            const col = document.getElementById('sortColumn').value;
            if (!col) return;
            const dir = document.getElementById('sortDirection').value;

            updateStatus('â³ ì •ë ¬ ì ìš© ì¤‘...');
            const start = performance.now();
            await sheet.sort([{ columnKey: col, direction: dir }]);
            const duration = performance.now() - start;
            updateStatus(`âœ… ì •ë ¬ ì™„ë£Œ (${Math.round(duration)}ms)`);
        };

        window.clearSort = async function () {
            if (!sheet) return;
            updateStatus('â³ ì •ë ¬ ì´ˆê¸°í™” ì¤‘...');
            const start = performance.now();
            await sheet.sort([]);
            const duration = performance.now() - start;
            updateStatus(`âœ… ì •ë ¬ ì´ˆê¸°í™” (${Math.round(duration)}ms)`);
        };

        // ì´ˆê¸°í™”
        initGrid().catch(console.error);
    </script>
</body>

</html>
