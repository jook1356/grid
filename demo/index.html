<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PureSheet Demo</title>
  <link rel="stylesheet" href="shared/styles.css">
  <link rel="stylesheet" href="../src/ui/style/default.css">
</head>
<body>
  <!-- 네비게이션 -->
  <nav class="demo-nav">
    <a href="index.html" class="active">🏠 홈</a>
    <a href="examples/column-pinning.html">📌 컬럼 고정</a>
    <a href="examples/multi-row.html">📑 Multi-Row</a>
    <a href="examples/grouping.html">📂 행 그룹화</a>
  </nav>
  
  <h1 style="margin-bottom: 8px;">🗃️ PureSheet Demo</h1>
  <p style="color: #666; margin-bottom: 24px;">고성능 가상화 그리드 라이브러리</p>
  
  <!-- 예제 카드 그리드 -->
  <div class="example-grid">
    <div class="example-card">
      <h3>📌 컬럼 고정</h3>
      <p>왼쪽/오른쪽에 컬럼을 고정하여 가로 스크롤 시에도 항상 표시됩니다.</p>
      <a href="examples/column-pinning.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>📑 Multi-Row 레이아웃</h3>
      <p>하나의 데이터 행을 여러 줄로 표시하여 복잡한 정보를 가독성 있게 보여줍니다.</p>
      <a href="examples/multi-row.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>📂 행 그룹화</h3>
      <p>데이터를 계층적으로 그룹화하고 집계(합계, 평균 등)를 표시합니다.</p>
      <a href="examples/grouping.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>⚡ 대용량 데이터</h3>
      <p>100만+ 행을 60fps로 부드럽게 스크롤합니다. 아래에서 테스트해보세요!</p>
      <a href="#grid" onclick="window.loadData && loadData(1000000)">100만 행 로드 →</a>
    </div>
  </div>
  
  <h2 style="margin-top: 32px; margin-bottom: 16px; font-size: 1.25rem; color: #333;">
    ⚡ 성능 테스트
  </h2>
  
  <div class="demo-container">
    <div class="toolbar">
      <button onclick="loadData(1000)">1,000 행 로드</button>
      <button onclick="loadData(10000)">10,000 행 로드</button>
      <button onclick="loadData(100000)">100,000 행 로드</button>
      <button onclick="loadData(1000000)">1,000,000 행 로드</button>
      <button onclick="loadData(5000000)">5,000,000 행 로드</button>
      <button class="secondary" onclick="selectAll()">전체 선택</button>
      <button class="secondary" onclick="clearSelection()">선택 해제</button>
      <button class="secondary" onclick="toggleTheme()">테마 전환</button>
    </div>
    
    <div id="grid"></div>
    
    <div class="status-bar" id="status">
      준비됨
    </div>
  </div>
  
  <div class="info-panel">
    <h3>선택된 행</h3>
    <pre id="selectedRows">[]</pre>
  </div>
  
  <script type="module">
    // 빌드된 모듈 대신 직접 import (개발용)
    // 실제 사용 시: import { PureSheet } from '@puresheet/core';
    
    // 데이터 생성 웹 워커 (백그라운드에서 대량 데이터 생성)
    const dataWorker = new Worker(
      new URL('./dataWorker.ts', import.meta.url),
      { type: 'module' }
    );
    
    // 워커 메시지 핸들러 (Promise로 래핑)
    function generateDataInWorker(count) {
      return new Promise((resolve) => {
        const handler = (event) => {
          const message = event.data;
          
          if (message.type === 'progress') {
            updateStatus(`${count.toLocaleString()}개 데이터 생성 중... ${message.percent}%`);
          } else if (message.type === 'complete') {
            dataWorker.removeEventListener('message', handler);
            resolve({ data: message.data, time: message.time });
          }
        };
        
        dataWorker.addEventListener('message', handler);
        dataWorker.postMessage({ type: 'generate', count });
      });
    }
    
    // PureSheet 인스턴스 (전역)
    let sheet = null;
    let isDarkTheme = false;
    
    // 상태 업데이트
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }
    
    function updateSelectedRows(rows) {
      const display = rows.slice(0, 10).map(r => ({ id: r.id, name: r.name }));
      if (rows.length > 10) {
        display.push({ '...': `외 ${rows.length - 10}개` });
      }
      document.getElementById('selectedRows').textContent = JSON.stringify(display, null, 2);
    }
    
    // 전역 함수 (버튼에서 호출)
    window.loadData = async function(count) {
      updateStatus(`${count.toLocaleString()}개 데이터 생성 중...`);
      
      // 웹 워커에서 데이터 생성 (UI 블로킹 없음)
      const { data, time: genTime } = await generateDataInWorker(count);
      
      updateStatus(`데이터 로드 중...`);
      
      if (sheet) {
        const loadStart = performance.now();
        await sheet.loadData(data);
        const loadTime = performance.now() - loadStart;
        
        updateStatus(`${count.toLocaleString()}개 행 로드 완료 (생성: ${genTime.toFixed(0)}ms, 로드: ${loadTime.toFixed(0)}ms)`);
      }
    };
    
    window.selectAll = function() {
      if (sheet) {
        sheet.selectAll();
        updateStatus('전체 선택됨');
      }
    };
    
    window.clearSelection = function() {
      if (sheet) {
        sheet.clearSelection();
        updateStatus('선택 해제됨');
        updateSelectedRows([]);
      }
    };
    
    window.toggleTheme = function() {
      isDarkTheme = !isDarkTheme;
      const container = document.querySelector('.ps-grid-container');
      if (container) {
        container.classList.toggle('ps-theme-dark', isDarkTheme);
      }
      updateStatus(`테마: ${isDarkTheme ? '다크' : '라이트'}`);
    };
    
    // 초기화
    async function init() {
      const container = document.getElementById('grid');
      
      // GridCore와 GridRenderer를 직접 사용 (PureSheet 빌드 전)
      const { GridCore, GridRenderer } = await import('../src/index.ts');
      
      const columns = [
        { key: 'id', header: 'ID', width: 60, pinned: 'left' },
        { key: 'name', header: 'Name', width: 150 },
        { key: 'email', header: 'Email', width: 250 },
        { key: 'department', header: 'Department', width: 120 },
        { key: 'status', header: 'Status', width: 100 },
        { key: 'salary', header: 'Salary', width: 100, formatter: (v) => '$' + v.toLocaleString() },
        { key: 'joinDate', header: 'Join Date', width: 120 },
      ];
      
      const gridCore = new GridCore({ columns });
      await gridCore.initialize();
      
      const renderer = new GridRenderer(container, {
        gridCore,
        options: {
          columns,
          rowHeight: 36,
          headerHeight: 40,
          resizableColumns: true,
          reorderableColumns: true,
          theme: 'light',
        },
        onRowClick: (rowIndex, row) => {
          console.log('Row clicked:', rowIndex, row);
          updateSelectedRows([row]);
        },
      });
      
      // 임시로 sheet 객체 생성 (loadData 함수용)
      sheet = {
        loadData: async (data) => {
          await gridCore.loadData(data);
          renderer.refresh();
        },
        selectAll: () => {
          console.log('Select all - not implemented in demo');
        },
        clearSelection: () => {
          console.log('Clear selection - not implemented in demo');
        },
      };
      
      // 초기 데이터 로드
      await window.loadData(1000);
    }
    
    init().catch(console.error);
  </script>
</body>
</html>
