<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PureSheet Demo</title>
  <link rel="stylesheet" href="shared/styles.css">
  <link rel="stylesheet" href="../src/ui/style/default.css">
</head>
<body>
  <!-- 네비게이션 -->
  <nav class="demo-nav">
    <a href="index.html" class="active">🏠 홈</a>
    <a href="examples/pinning.html">📌 행/컬럼 고정</a>
    <a href="examples/multi-row.html">📑 Multi-Row</a>
    <a href="examples/grouping.html">📂 행 그룹화</a>
    <a href="examples/merge.html">🔗 셀 병합</a>
    <a href="examples/selection-modes.html">🎯 선택 모드</a>
    <a href="examples/pivot.html">📊 피벗</a>
    <a href="examples/format-row.html">🎨 formatRow</a>
  </nav>
  
  <h1 style="margin-bottom: 8px;">🗃️ PureSheet Demo</h1>
  <p style="color: #666; margin-bottom: 24px;">고성능 가상화 그리드 라이브러리</p>
  
  <!-- 예제 카드 그리드 -->
  <div class="example-grid">
    <div class="example-card">
      <h3>📌 행/컬럼 고정</h3>
      <p>행과 컬럼을 상하좌우에 고정하여 스크롤해도 항상 표시됩니다.</p>
      <a href="examples/pinning.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>📑 Multi-Row 레이아웃</h3>
      <p>하나의 데이터 행을 여러 줄로 표시하여 복잡한 정보를 가독성 있게 보여줍니다.</p>
      <a href="examples/multi-row.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>📂 행 그룹화</h3>
      <p>데이터를 계층적으로 그룹화하고 집계(합계, 평균 등)를 표시합니다.</p>
      <a href="examples/grouping.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>🔗 셀 병합</h3>
      <p>같은 값을 가진 연속된 셀을 병합합니다. 계층적 병합도 지원.</p>
      <a href="examples/merge.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>⚡ 대용량 데이터</h3>
      <p>100만+ 행을 60fps로 부드럽게 스크롤합니다. 아래에서 테스트해보세요!</p>
      <a href="#grid" onclick="window.loadData && loadData(1000000)">100만 행 로드 →</a>
    </div>
    
    <div class="example-card">
      <h3>🎯 선택 모드</h3>
      <p>행 선택, 셀 선택, 또는 둘 다. 다양한 선택 모드를 지원합니다.</p>
      <a href="examples/selection-modes.html">예제 보기 →</a>
    </div>
    
    <div class="example-card">
      <h3>📊 피벗 그리드</h3>
      <p>데이터를 행/열 축으로 교차 집계합니다. 다중 레벨 헤더 자동 생성.</p>
      <a href="examples/pivot.html">예제 보기 →</a>
    </div>

    <div class="example-card">
      <h3>🎨 formatRow API</h3>
      <p>행 렌더링 시 조건부 스타일링. Wijmo formatItem보다 20배 효율적.</p>
      <a href="examples/format-row.html">예제 보기 →</a>
    </div>

    <div class="example-card">
      <h3>📏 컬럼 너비</h3>
      <p>px, rem, %, auto 등 다양한 CSS 단위로 컬럼 너비 지정. minWidth/maxWidth 지원.</p>
      <a href="examples/column-widths.html">예제 보기 →</a>
    </div>
  </div>
  
  <h2 style="margin-top: 32px; margin-bottom: 16px; font-size: 1.25rem; color: #333;">
    ⚡ 성능 테스트
  </h2>
  
  <div class="demo-container">
    <div class="toolbar">
      <button onclick="loadData(1000)">1,000 행 로드</button>
      <button onclick="loadData(10000)">10,000 행 로드</button>
      <button onclick="loadData(100000)">100,000 행 로드</button>
      <button onclick="loadData(1000000)">1,000,000 행 로드</button>
      <button onclick="loadData(5000000)">5,000,000 행 로드</button>
      <button class="secondary" onclick="selectAll()">전체 선택</button>
      <button class="secondary" onclick="clearSelection()">선택 해제</button>
      <button class="secondary" onclick="toggleTheme()">테마 전환</button>
    </div>
    
    <div id="grid"></div>
    
    <div class="status-bar" id="status">
      준비됨
    </div>
  </div>
  
  <div class="info-panel">
    <h3>선택 정보</h3>
    <pre id="selectedRows">[]</pre>
  </div>
  
  <script type="module">
    // PureSheet 사용 (완전한 기능 지원)
    
    // 데이터 생성 웹 워커 (백그라운드에서 대량 데이터 생성)
    const dataWorker = new Worker(
      new URL('./dataWorker.ts', import.meta.url),
      { type: 'module' }
    );
    
    // 워커 메시지 핸들러 (Promise로 래핑)
    function generateDataInWorker(count) {
      return new Promise((resolve) => {
        const handler = (event) => {
          const message = event.data;
          
          if (message.type === 'progress') {
            updateStatus(`${count.toLocaleString()}개 데이터 생성 중... ${message.percent}%`);
          } else if (message.type === 'complete') {
            dataWorker.removeEventListener('message', handler);
            resolve({ data: message.data, time: message.time });
          }
        };
        
        dataWorker.addEventListener('message', handler);
        dataWorker.postMessage({ type: 'generate', count });
      });
    }
    
    // PureSheet 인스턴스 (전역)
    let sheet = null;
    let isDarkTheme = false;
    
    // 상태 업데이트
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }
    
    function updateSelectionInfo(state) {
      const info = {
        selectedRows: state.selectedRows?.length || 0,
        selectedCells: state.selectedCells?.length || 0,
      };
      
      // 행 선택 정보 (셀 선택 시 해당 행도 자동 포함됨)
      if (state.selectedRows?.length > 0) {
        info.rowIds = state.selectedRows.slice(0, 5);
        if (state.selectedRows.length > 5) {
          info.rowIds.push(`... 외 ${state.selectedRows.length - 5}개`);
        }
      }
      
      // 셀 선택 정보
      if (state.selectedCells?.length > 0) {
        info.cells = state.selectedCells.slice(0, 10);
        if (state.selectedCells.length > 10) {
          info.cells.push(`... 외 ${state.selectedCells.length - 10}개 셀`);
        }
      }
      
      document.getElementById('selectedRows').textContent = JSON.stringify(info, null, 2);
    }
    
    // 전역 함수 (버튼에서 호출)
    window.loadData = async function(count) {
      updateStatus(`${count.toLocaleString()}개 데이터 생성 중...`);
      
      // 웹 워커에서 데이터 생성 (UI 블로킹 없음)
      const { data, time: genTime } = await generateDataInWorker(count);
      
      updateStatus(`데이터 로드 중...`);
      
      if (sheet) {
        const loadStart = performance.now();
        await sheet.loadData(data);
        const loadTime = performance.now() - loadStart;
        
        updateStatus(`${count.toLocaleString()}개 행 로드 완료 (생성: ${genTime.toFixed(0)}ms, 로드: ${loadTime.toFixed(0)}ms)`);
      }
    };
    
    window.selectAll = function() {
      if (sheet) {
        sheet.selectAll();
        updateStatus('전체 선택됨');
      }
    };
    
    window.clearSelection = function() {
      if (sheet) {
        sheet.clearSelection();
        updateStatus('선택 해제됨');
        updateSelectionInfo({ selectedRows: [], selectedCells: [] });
      }
    };
    
    window.toggleTheme = function() {
      isDarkTheme = !isDarkTheme;
      const container = document.querySelector('.ps-grid-container');
      if (container) {
        container.classList.toggle('ps-theme-dark', isDarkTheme);
      }
      updateStatus(`테마: ${isDarkTheme ? '다크' : '라이트'}`);
    };
    
    // 초기화
    async function init() {
      const container = document.getElementById('grid');
      
      // PureSheet import
      const { PureSheet } = await import('../src/index.ts');
      
      const columns = [
        { key: 'id', header: 'ID', width: 60, frozen: 'left' },
        { key: 'name', header: 'Name', width: 150 },
        { key: 'email', header: 'Email', width: 250 },
        { key: 'department', header: 'Department', width: 120 },
        { key: 'status', header: 'Status', width: 100 },
        { key: 'salary', header: 'Salary', width: 100, formatter: (v) => '$' + v.toLocaleString() },
        { key: 'joinDate', header: 'Join Date', width: 120 },
      ];
      
      // PureSheet 인스턴스 생성 (완전한 기능 지원)
      sheet = new PureSheet(container, {
        columns,
        rowHeight: 36,
        headerHeight: 40,
        selectionMode: 'all',       // 셀+행 모두 선택 (셀 선택 시 행도 자동 동기화)
        multiSelect: true,          // 다중 선택 허용
        resizableColumns: true,
        reorderableColumns: true,
        theme: 'light',
      });
      
      // 선택 변경 이벤트
      sheet.on('selection:changed', (state) => {
        updateSelectionInfo(state);
      });
      
      // 행 클릭 이벤트
      sheet.on('row:click', ({ row, rowIndex }) => {
        console.log('Row clicked:', rowIndex, row);
      });
      
      // 셀 클릭 이벤트
      sheet.on('cell:click', ({ row, columnKey, value }) => {
        console.log('Cell clicked:', columnKey, value);
      });
      
      // 초기 데이터 로드
      await window.loadData(1000);
      
      updateStatus('준비 완료! 드래그로 셀 선택, Shift+클릭으로 범위 확장, Ctrl+클릭으로 개별 선택');
    }
    
    init().catch(console.error);
  </script>
</body>
</html>
